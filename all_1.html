<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  阿勒西的小屋
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="阿勒西的小屋" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
 
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 阿勒西的小屋</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="Tech.html">Tech</a></li>
        
            <li><a href="%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">读书笔记</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15934213696180.html">
                
                  <h1>解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>有时候解决一个问题很简单，但是其中发现问题和深入问题的过程却值得我们反复思考</p>
</blockquote>

<h2 id="toc_0">出现了问题</h2>

<p>最近在测试环境新搭的一套<code>proxysql</code>忽然无法正常登录了，一直提示连接<code>hostgroup</code>超时。</p>

<p>我首先跳过<code>proxysql</code>，直接连接后端的<code>mysql</code>节点，确认是<code>proxysql</code>的问题还是<code>mysql</code>的问题。</p>

<p>但是连接一直处于进行中的状态，不提示登录成功也不提示登录失败。</p>

<h2 id="toc_1">初步判断和尝试解决</h2>

<p>初步判断应该是<code>mysql</code>的连接数被打满了。</p>

<p>使用命令查看连接数</p>

<pre><code class="language-shell">netstat -naplt|grep 6033|wc -l
</code></pre>

<p>连接数显示<code>mysql</code>的连接已经被占满了。</p>

<p>由于后端的<code>mysql</code>节点只通过<code>proxysql</code>来访问，其他的程序并不知道<code>mysql</code>实例的端口号，所以尝试重启<code>proxysql</code>来释放连接。</p>

<p>再次尝试连接后端<code>mysql</code>节点，这次直接提示连接数过多，连接失败。</p>

<p>显然，重启<code>proxysql</code>并没有成功的解决问题。</p>

<h2 id="toc_2">挖掘问题并再次尝试解决</h2>

<p>仔细查看<code>netstat</code>输出的信息。</p>

<p>发现绝大部分的连接都是<code>TIME_WAIT</code>。</p>

<p>之后，通过重启<code>mysql</code>暂时的清理掉了这些连接，但是，首先，重启<code>mysql</code>的成本过高，在线上根本不可行，其次，暂时清理掉<code>TIME_WAIT</code>的连接之后，<code>TIME_WAIT</code>的连接数又很快的涨了上来。这并没有从根本上解决问题。</p>

<p>尝试通过<code>proxysql</code>的参数进行连接数限制，但是，<code>TIME_WAIT</code>状态的连接根本不被计算在<code>proxysql</code>的连接中，无法被限制。</p>

<p>查阅资料暂时解决了问题<br/>
查询了相关资料后，发现可以通过修改<code>Linux</code>内核参数来优化<code>TCP连接</code>。</p>

<p>编辑<code>/etc/sysctl.conf</code></p>

<pre><code class="language-ini"># 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
net.ipv4.tcp_tw_reuse = 1 
# 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
net.ipv4.tcp_tw_recycle = 1 
# 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。
net.ipv4.tcp_fin_timeout = 30 
# 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。
net.ipv4.tcp_max_tw_buckets = 400
</code></pre>

<p>通过开启<code>tcp复用</code>，<code>tcp快速回收</code>，修改<code>tcp fin超时时间</code>依然无法降低<code>TIME_WAIT</code>连接的数量。</p>

<p>最后，通过修改<code>TIME_WAIT</code>的最大保持数量，将<code>TIME_WAIT</code>的连接数量控制在<code>mysql</code>的最大连接数以内，暂时保证了<code>mysql</code>的可用性。</p>

<p>但是，我们依然并没有从根本解决问题。</p>

<h2 id="toc_3">深入了解TIME_WAIT连接尝试解决问题</h2>

<p>为了解决问题，我们先了解一下<code>TIME_WAIT</code>是什么。</p>

<p><img src="media/15934213696180/15934216027787.jpg" alt="tcp_conn"/></p>

<p>在关闭<code>TCP</code>连接的四次握手中，<code>客户端</code>先向<code>服务器端</code>发送<code>FIN报文</code>，告诉服务器端“我要断开连接了”，服务器端收到<code>FIN</code>后会回复一个<code>ACK</code>，表示收到断开连接的请求，但此时<code>服务器端</code>可能仍有数据未发送完，当服务器将数据发送完成后，<code>服务器端</code>会发送一个<code>FIN报文</code>，表示可以断开连接，<code>客户端</code>接收到<code>FIN报文</code>以后会发送一个<code>ACK报文</code>，此时<code>客户端</code>会发送一个<code>ACK报文</code>，然后<code>客户端</code>进入<code>TIME_WAIT</code>状态，当等待<code>2MSL（两个最大报文段生存时间）</code>之后，如果没有再接收到<code>服务器端</code>的请求，连接就会自动断开。</p>

<p>换句话说，当连接进入<code>TIME_WAIT</code>状态以后，我们不需要做任何事情，也无法做任何事情，我们所能做的唯一的事情就是等待一段时间以后，<code>TIME_WAIT</code>的连接就会自动断开。</p>

<p>所以<code>TIME_WAIT</code>的问题并不是连接没有被释放，而是这些<code>TIME_WAIT</code>的连接被创建的太多了。</p>

<p>由于在该环境中，<code>mysql</code>只有<code>proxysql</code>在连接，所以我尝试修改了一些<code>proxysql</code>中关于连接的参数<code>mysql-free_connections_pct</code>、<code>mysql-max_stmts_per_connection</code>等，但是依然无效。</p>

<h2 id="toc_4">问题解决和总结</h2>

<p>最后，该问题的解决是通过修复<code>mysql</code>中<code>monitor</code>用户而解决的。</p>

<p><code>monitor</code>用户是<code>proxysql</code>用以监控<code>mysql</code>的用户，<code>proxysql</code>会定时调用该用户从<code>mysql</code>中获取数据。而在<code>mysql</code>中该用户其实并没有被正确的创建，虽然在一开始我就从<code>log</code>中发现了这个问题，但是我并不认为这会导致<code>mysql</code>节点不可用，所以就忽略了这问题。但是，没有想到，虽然<code>monitor</code>用户无法正常的连接到<code>mysql</code>，但是会创建一个<code>TIME_WAIT</code>的连接。而且，由于不同的尝试连接，导致连接数过大，造成<code>mysql</code>无法使用。</p>

<p>在解决了问题之后，又通过简单的<code>python</code>程序验证了这一状况。</p>

<pre><code class="language-python">import mysql.connector

for i in range(100):
    try:
        conn1 = mysql.connector.connect(user=&#39;aaa&#39;, password=&#39;aaa&#39;, host=&#39;192.168.100.10&#39;, port=3306)
    except (mysql.connector.errors.ProgrammingError) as e:
        print(i + 1, &quot; : &quot;, e)
print(&quot;the end&quot;)
</code></pre>

<p>在上面的脚本中，使用错误的用户名密码不断地连接数据库。</p>

<p>然后，通过监控<code>TIME_WAIT</code>数量，发现虽然连接都失败了，但是每一次尝试连接都会产生一个<code>TIME_WAIT</code>的连接。</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/01/10</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='ProxySQL.html'>ProxySQL</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934218730531.html">
                
                  <h1>yaourt/pacman加速3连</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>这两天更新包的时候感觉速度有点慢，于是就做了一些优化改进，顺手总结一下</p>

<ol>
<li><p>改源<br/>
将下载源改成国内源是最常见的一种，不过<code>Arch</code>一般在安装的时候就会进行改源操作。</p>
<p>在<code>/etc/pacman.d/mirrorlist</code>中包含的源已经很全了，我们只需要将不需要的一些国外源注释掉或者删掉就行了。</p>
<p>另外，我们一般也会添加一下<code>archlinuxcn</code>的镜像源。</p>
<p>只需要修改一下<code>/etc/pacman.conf文件</code>，在最底下添加</p>
<pre><code class="language-ini">[archlinuxcn]
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch
</code></pre>
<p>然后安装一下<code>archlinuxcn-keyring</code></p>
<pre><code class="language-shell">yaourt -S archlinuxcn-keyring
</code></pre></li>
<li><p>并行<br/>
<code>pacman</code>默认是使用<code>wget</code>进行下载的，我们可以在配置中，将它改为其他的多线程下载工具</p>
<p>编辑配置文件<code>/etc/pacman.conf</code>，添加以下参数</p>
<pre><code class="language-shell">XferCommand = /usr/bin/aria2c -s 5 %u
</code></pre>
<p>可以调节<code>-s</code>后面的参数，修改并行数</p></li>
<li><p>加代理<br/>
有时候我们下载国外网站的一些包的时候可能需要科学上网，下面提供一种方法可以让命令行通过ss进行科学上网</p>
<pre><code class="language-shell"># 安装privoxy
sudo pacman -S privoxy<br/>
# 编辑配置文件<br/>
sudo vim /etc/privoxy/config<br/>
# 在文件中添加一行（最后有一个点，别漏了）<br/>
forward-socks5 / 127.0.0.1:7070 .<br/>
# 启动privoxy服务<br/>
sudo systemctl start privoxy.service<br/>
# 配置环境变量<br/>
export https_proxy=127.0.0.1:8118<br/>
export http_proxy=127.0.0.1:8118
</code></pre></li>
</ol>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/01/08</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Arch.html'>Arch</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934220934752.html">
                
                  <h1>安装合集</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>汇总了一些常见软件的安装命令，复制即用，炒鸡简单【CentOS】</p>
</blockquote>

<h2 id="toc_0">EPEL【yum】</h2>

<p><code>epel</code>几乎是<code>CentOS</code>的必备很多软件和依赖都可以在<code>epel</code>中找到</p>

<pre><code class="language-shell">yum install epel-release
</code></pre>

<h2 id="toc_1">MySQL【yum】</h2>

<pre><code class="language-shell"># 安装 Percona 仓库
yum install http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm 
# mysql5.7 
yum install Percona-Server-client-57 Percona-Server-devel-57 Percona-Server-server-57 Percona-Server-shared-57 
# mysql5.6 
yum install Percona-Server-client-56 Percona-Server-devel-56 Percona-Server-server-56 Percona-Server-shared-56 
# 相关的软件和工具 
yum install percona-xtrabackup-24 percona-toolkit 
# mysql5.7的一些准备工作
# mysql5.7初始化
$ mysqld --initialize
# mysql5.7中使用了一些新的密码策略，所以我们的配置会麻烦一些
# mysql5.7中，root用户是有初始密码的，改密码存在mysql的错误日志中
$ grep &quot;password&quot; /var/log/mysqld.log
2017-06-17T12:25:17.375581Z 1 [Note] A temporary password is generated for root@localhost: cul+b=F7vF*o
# mysql5.7中会检查密码的复杂度，简单的密码无法被设置，我们可以关闭该策略，在生产环境中不建议这么做
set global validate_password_policy=0;
# 虽然我们可以设置简单的密码了，但是mysql对于密码的长度还是有要求的，该值也可以被修改，同步不建议在生产环境这么做
set global validate_password_length=1;
# 然后我们就可以修改root用户的密码了
ALTER USER USER() IDENTIFIED BY &#39;123456&#39;;
</code></pre>

<h2 id="toc_2">Redis【yum】</h2>

<pre><code class="language-shell"># Redis在epel中就有，不过版本一般比较老，要安装新版的redis可以在remi源中找
# 安装 remi 源
# CentOS6版本的remi源
yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-6.rpm 
# CentOS7版本的remi源
yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm 
# 启用remi，并查看可以安装的redis版本
yum --enablerepo=remi list redis --showduplicates
# 选择合适的版本安装就可以了，软件名和版本号之间用“-”链接
</code></pre>

<h2 id="toc_3">NodeJS【yum】</h2>

<pre><code class="language-shell"># 安装9.x的仓库
curl -sL https://rpm.nodesource.com/setup_9.x | bash -
# 安装8.x的仓库
curl -sL https://rpm.nodesource.com/setup_8.x | bash -
# 安装nodejs
yum install -y nodejs
# 安装cnpm
npm install -g cnpm --registry=https://registry.npm.taobao.org
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/01/03</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='CentOS.html'>CentOS</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934225595265.html">
                
                  <h1>使用Navicat链接proxysql无法进行用户管理</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>今天使用<code>Navicat</code>链接<code>proxysql</code>修改后端数据库用户权限的时候，莫名其妙的出现了一个报警<br/>
<img src="media/15934225595265/15934225922074.jpg" alt=""/><br/>
这个问题在之前并没有遇到过，看这个描述，因该是找不到<code>password</code>字段，初步的猜测是在<code>proxysql</code>中设置的<code>mysql</code>版本号和实际连接的<code>mysql</code>版本号不一致，而恰巧这两个版本中记录<code>mysql</code>用户信息的表结构也不一致，导致<code>Navicat</code>根据错误的版本号使用了错误的查询语句，最后导致查询报错。</p>

<p>随后我查询的<code>proxysql</code>中标记的版本号，和后端连接的<code>mysql</code>的版本号，发现这两个值确实不一致，而直接连接后端的数据库访问用户管理项的时候，也没有报错。</p>

<p>那么事情就好办了，修改一下<code>proxysql的mysql-server_version</code>然后<code>load mysql variables to run;</code>，完结，撒花～</p>

<p>…</p>

<p>…</p>

<p>但是事情永远不可能向你想象中的那么顺利，<code>load</code>之后，报错依旧。</p>

<p>这。。。</p>

<p>好，祭出牛刀，<code>tcpflow</code></p>

<p><code>tcpflow</code>和<code>tcpdump</code>差不多，都是抓包的，但是个人感觉比<code>tcpdump</code>好用</p>

<p>怎么安装就不说了，我本地是<code>ArchLinux</code>，直接<code>yaourt</code>就可以了，<code>CentOS</code>的我以后可能会写篇文章单独讲。</p>

<p>直接上命令，查看发往<code>proxysql</code>的流量</p>

<pre><code class="language-shell">$ sudo tcpflow -c -p -i any dst port 3306
</code></pre>

<p>于是可以看到，当我们在<code>Navicat</code>上点击用户表单的时候，会向<code>mysql</code>发送一条命令</p>

<pre><code class="language-shell">SELECT user, host, password, ssl_type, ssl_cipher, x509_issuer, x509_subject, max_questions, max_updates, max_connections, super_priv, max_user_connections FROM mysql.user ORDER BY user
</code></pre>

<p>这里会查询一个<code>password</code>字段，而当我们直接连接后端的<code>mysql</code>节点的时候，发送的请求是</p>

<pre><code class="language-shell">SELECT user, host, authentication_string, ssl_type, ssl_cipher, x509_issuer, x509_subject, max_questions, max_updates, max_connections, super_priv, max_user_connections, plugin, password_expired, password_lifetime FROM mysql.user ORDER BY user
</code></pre>

<p>注意，这里已经没有了<code>password</code>字段，取而代之的是<code>authentication_string</code>字段，这就是<code>5.6</code>版本和<code>5.7</code>版本的区别。</p>

<p>但是我明明已经将<code>proxysql</code>中的版本号改掉，并且<code>load</code>了，但是为什么没有生效？！</p>

<p>好吧，可能是bug吧，事实上<code>proxysql</code>虽然号称可以试试修改配置项，但是实际操作中配置项修改后不能实时生效的绝对不知这一处，比如修改监听端口就需要重启服务才能生效。</p>

<p>那么我们保存配置<code>save mysql variables to disk;</code></p>

<p>然后重启服务</p>

<pre><code class="language-shell">$ service proxysql restart
</code></pre>

<p>再次用Navicat访问用户表单，终于正常了。</p>

<p>整个总结下来就两个字<code>坑爹</code></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/12/28</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='MySQL.html'>MySQL</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934230143658.html">
                
                  <h1>使用cachecloud和codis搭建redis环境</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">简单的介绍：</h2>

<p>CacheCloud：<br/>
<code>CacheCloud</code>是由<code>souhutv</code>开源一套<code>Redis</code>的管理系统，可以帮助我们自动化的搭建和运维<code>Redis</code>，<code>Cachecloud</code>可以自动部署和管理3种形式的Redis方案，包括单实例<code>Redis</code>，<code>Redis+Sentinel</code>以及Redis的原生集群方案<code>Redis Cluster</code></p>

<p>Codis：<br/>
<code>Codis</code>是由豌豆荚开源的一套Redis集群方案，是通过proxy路由到不同分片来实现的<code>redis</code>集群</p>

<h2 id="toc_1">Codis安装：</h2>

<h3 id="toc_2">1. 安装Go环境</h3>

<pre><code class="language-text">在Go语言的下载页面选择一个你要使用的安装包下载。我选择的是1.9.2版本。
```shell
wget https://redirector.gvt1.com/edgedl/go/go1.9.2.linux-amd64.tar.gz
```
修改/etc/profile文件
```shell
export GOROOT=/data/go/
export PATH=$PATH:/$GOROOT/bin
```
重新加载/etc/profile
```shell
source /etc/profile
```
查看Go是否安装成功
```shell
$ go version
go version go1.9.2 linux/amd64
```
</code></pre>

<h3 id="toc_3">2. 安装Codis</h3>

<pre><code class="language-text">首先我们需要知道`GOPATH`的路径
```shell
$ go env GOPATH
/root/go
```
Go安装成功后，GOPATH会在`～/go`目录下，我这值我们也可以进行修改，比如，修改为`/data/gopath`
```shell
export GOPATH=/data/gopath
```
然后我们需要将codis的代码`clone`到指定的目录下
```shell
$ mkdir -p $GOPATH/src/github.com/CodisLabs
$ cd $GOPATH/src/github.com/CodisLabs
$ git clone https://github.com/CodisLabs/codis.git -b release3.2
```
获取到源码后，我们只需要`make`一下就可以了
```shell
$ cd codis
$ make
make -j4 -C extern/redis-3.2.11/
make[1]: 进入目录“/data/gopath/src/github.com/CodisLabs/codis/extern/redis-3.2.11”
cd src &amp;&amp; make all
...
```
在这个过程中你可能需要安装一些工具，比如
```shell
yum groupinstall &quot;Development Tools&quot;
```
在安装过程中可能会遇到如下的错误

&gt; zmalloc.h:50:31: 致命错误：jemalloc/jemalloc.h：没有那个文件或目录

这是因为没有找到`jemalloc`内存管理器的缘故，
我们可以在编译的时候指定其他的内存管理
```shell
make MALLOC=libc
```
但是相比`jemalloc`，其他的内存管理器可能会造成更多的内存碎片（`mem_fragmentation_ratio`）
当然，为了更好的性能，我们自然会选择`jemalloc`，那么我们就需要安装`jemalloc`了，但是如果我们现在使用`yum`安装，可以依然会编译`codis`报错，因为`jemalloc`没有被安装到指定的目录，而在`redis`的安装包里`redis`自己就为我们提供一个`deps`目录，里面就有`jemalloc`和其他一些依赖的安装包。
但是`codis`的目录下为我们提供了多个版本的`redis`，我们需要使用那个呢？
刚才我们在`make`的时候，第一行输出是
```shell
make -j4 -C extern/redis-3.2.11/
```
这里我们就可以进入该目录，直接编译deps下的所有依赖
```shell
cd extern/redis-3.2.11/deps
make hiredis jemalloc linenoise lua geohash-int
```
再次回到原目录，编译成功
</code></pre>

<h2 id="toc_4">启动Codis：</h2>

<h3 id="toc_5">启动<code>Codis</code>会用到<code>zk</code>或者<code>etctd</code>，这里我使用的是<code>zk</code></h3>

<p>安装<code>JDK</code>和<code>ZOOKEEPER</code>`<code><br/>
</code>JDK<code>可以直接使用</code>yum`安装</p>

<pre><code class="language-shell">yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel
</code></pre>

<p>安装完<code>JDK</code>记得要配置环境变量，不然可能会导致一些程序不可用<br/>
<code>vim /etc/profile</code></p>

<pre><code class="language-shell">#set java environment  
JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.151-1.b12.el6_9.x86_64
PATH=$PATH:$JAVA_HOME/bin
CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export JAVA_HOME  CLASSPATH  PATH
</code></pre>

<p>加载一下配置文件<code>source /etc/profile</code></p>

<p>ZOOKEEPER需要从官网下载安装包，我部署的是单节点的，解压后直接启动就可以</p>

<pre><code class="language-shell">wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz
tar -zxf zookeeper-3.4.11.tar.gz
cd zookeeper-3.4.11/conf
cp zoo_sample.cfg zoo.cfg
cd zookeeper-3.4.11/bin
./zkServer.sh start
</code></pre>

<h3 id="toc_6">配置与启动</h3>

<p><img src="media/15934230143658/15934236957711.jpg" alt="codis架构图"/></p>

<p>如上图，Codis集群架构可以分为几个部分</p>

<p>最核心的是<code>codis-dashboard</code>和<code>codis-proxy</code></p>

<ul>
<li><code>codis-dashboard</code>是<code>codis</code>的集群管理工具，可以管理<code>codis-proxy</code>、<code>codis-server</code>和<code>Redis-sentinel</code></li>
<li><code>codis-proxy</code>负责<code>codis</code>集群中的代理工作，负责将<code>redis</code>命令路由到不同的分片</li>
<li><code>codis-fe</code>是<code>codis-dashboard</code>的<code>web</code>管理界面，可以更方便、更形象的管理集群</li>
<li><code>codis-serer</code>是在<code>redis-server</code>基础上增加了<code>codis</code>相关命令而形成的另一个分支
现在我们要启动<code>Codis</code></li>
</ul>

<p>我们先进入<code>codis</code>的配置文件目录<code>/data/gopath/src/github.com/CodisLabs/codis/config</code>修改<code>codis-dashboard</code>的配置文件，<code>codis-dashboard</code>默认使用<code>filesystem</code>作为外部存储，我们将其修改为<code>zookeeper</code>。</p>

<p>然后将<code>product_name</code>修改为该我们的<code>codis</code>集群的名字，这里我们改成<code>codis-test</code></p>

<pre><code class="language-shell"># Set Coordinator, only accept &quot;zookeeper&quot; &amp; &quot;etcd&quot; &amp; &quot;filesystem&quot;.
# for zookeeper/etcd, coorinator_auth accept &quot;user:password&quot; 
# Quick Start
# coordinator_name = &quot;filesystem&quot;
# coordinator_addr = &quot;/tmp/codis&quot;
coordinator_name = &quot;zookeeper&quot;
coordinator_addr = &quot;127.0.0.1:2181&quot;
#coordinator_auth = &quot;&quot;

# Set Codis Product Name/Auth.
product_name = &quot;codis-test&quot;
product_auth = &quot;&quot;
</code></pre>

<p>现在启动<code>codis-dashboard</code></p>

<pre><code class="language-shell">nohup ./bin/codis-dashboard --ncpu=4 --config=config/dashboard.toml --log=logs/dashboard.log --log-level=WARN &amp;
</code></pre>

<p>这里我新建了一个<code>logs</code>目录来存放日志</p>

<p><code>codis-proxy</code>也有相应的配置文件，这里我只是简单的修改了一下<code>product_name</code>，然后启动相关的服务</p>

<pre><code class="language-shell"># 启动 codis-proxy
nohup ./bin/codis-proxy --ncpu=4 --config=config/proxy.toml --log=logs/proxy.log --log-level=WARN &amp;
# 启动 codis-fe，这里监听的是8080端口
nohup ./bin/codis-fe --ncpu=4 --log=logs/fe.log --log-level=WARN --zookeeper=127.0.0.1:2181 --listen=0.0.0.0:8080 &amp;
</code></pre>

<p>现在我们已经可以访问管理页面了</p>

<p>进入管理界面中，我们先添加一个<code>proxy</code></p>

<p><img src="media/15934230143658/15934240026925.jpg" alt="添加codis-proxy"/></p>

<p>接下来我们就可以添加<code>codis-server</code>和<code>sentinel</code>了，但是在那之前，我们先安装一下<code>CacheCloud</code></p>

<h2 id="toc_7">安装CacheCloud：</h2>

<p>我们先从<del>gayhub</del> github上 的获取源码</p>

<pre><code class="language-shell">cd /opt
git clone https://github.com/sohutv/cachecloud.git
</code></pre>

<p>由于程序需要用到<code>maven</code>，我们需要先安装<code>maven</code></p>

<pre><code class="language-shell">wget http://repos.fedorapeople.org/repos/dchen/apache-maven/epel-apache-maven.repo -O /etc/yum.repos.d/epel-apache-maven.repo
yum -y install apache-maven
</code></pre>

<p>现在我们需要修改一下配置文件，配置一下使用的<code>mysql</code>和监听的端口</p>

<pre><code class="language-shell">$ vim /opt/cachecloud/cachecloud-open-web/src/main/swap/online.properties
cachecloud.db.url = jdbc:mysql://127.0.0.1:3306/cache-cloud
cachecloud.db.user = admin
cachecloud.db.password = 123456
cachecloud.maxPoolSize = 20

isClustered = true
isDebug = false
spring-file=classpath:spring/spring-online.xml
log_base=/opt/cachecloud-web/logs
web.port=8585
log.level=WARN
</code></pre>

<p>启动<code>cachecloud</code></p>

<pre><code class="language-shell"># 进入cachecloud的根目录
cd /opt/cachecloud
# 运行maven
mvn clean compile install -Ponline
# 新建cachecloud-web目录
mkdir /opt/cachecloud-web
# 拷贝war包、配置文件和启动脚本
cp /opt/cachecloud/cachecloud-open-web/target/cachecloud-open-web-1.0-SNAPSHOT.war /opt/cachecloud-web
cp /opt/cachecloud/cachecloud-open-web/src/main/resources/cachecloud-web.conf /opt/cachecloud-web
cp /opt/cachecloud/script/st*.sh /opt/cachecloud-web
# 初始化数据库
mysql -uadmin -p -D&#39;cache-cloud&#39; &lt; /opt/cachecloud/script/cachecloud.sql
# 启动
sh /opt/cachecloud-web/start.sh
</code></pre>

<p>如果你发现启动脚本运行的时间很长，可能是已经报错了，<code>tail</code>一下日志</p>

<p>如果报<code>Unrecognized VM option &#39;UnlockCommercialFeatures&#39;</code>的错误，在启动脚本中将<code>-XX:+UnlockCommercialFeatures -XX:+FlightRecorder</code>去掉即可</p>

<h2 id="toc_8">使用CacheCloud和配置Redis：</h2>

<p>在<code>cachecloud</code>的<code>script</code>目录下有一个初始化脚本<code>cachecloud-init.sh</code></p>

<p>这个脚本有3个作用：</p>

<ol>
<li>创建cachecloud项目的用户</li>
<li>创建cachecloud项目的相关目录</li>
<li>安装redis</li>
</ol>

<p>将这个脚本拷贝到需要管理的机器上，然后执行</p>

<pre><code class="language-shell">./cachecloud-init.sh username
</code></pre>

<p>此处的<code>username</code>是你用于创建管理<code>redis</code>的用户名</p>

<p>执行后，你需要输入两次密码</p>

<p>使用管理员账号进入<code>web</code>管理页面，在<code>管理后台</code>&gt;<code>机器管理</code>中添加我们初始化后的机器</p>

<p>接着，我们可以使用任意账号在应用申请界面申请<code>redis</code>服务</p>

<p><code>cachecloud</code>提供3种<code>redis</code>服务</p>

<ol>
<li>单节点redis</li>
<li>Redis-Sentinel</li>
<li>原生的Redis-Cluster集群</li>
</ol>

<p>申请了我们需要的<code>redis</code>服务之后，管理员就可以在<code>管理后台</code>&gt;<code>流程审批</code>界面分配<code>redis</code>服务了</p>

<h2 id="toc_9">使用CacheCloud配置Codis集群</h2>

<h3 id="toc_10">为codis添加redis-server</h3>

<p>值得注意的是，<code>Codis</code>集群不能直接使用<code>Redis-Server</code>，我们需要使用<code>codis</code>安装目录下的<code>codis-server</code>替换掉<code>PATH</code>路径下的<code>redis-server</code></p>

<pre><code class="language-shell">cp codis-server /usr/bin/redis-server
cp codis-server /usr/local/bin/redis-server
</code></pre>

<p>这样我们使用<code>CacheCloud</code>创建的就是<code>codis-server</code>了</p>

<p>现在我们在<code>CacheCloud</code>中创建两个单节点<code>redis</code>，然后在<code>管理后台</code>&gt;<code>流程审批</code>&gt;<code>应用运维</code>中为两个<code>redis</code>分别配置<code>slave</code></p>

<p>现在我们得到了两对<code>redis</code>主从，然后我们进入<code>Codis</code>的管理界面，在<code>Group</code>中将这两对主从添加为两组<code>Group</code>，再在<code>Slots</code>中点击<code>Reblance All Slots</code></p>

<p>至此<code>Codis</code>集群就搭建完成了</p>

<p>现在我们为<code>Codis</code>集群添加<code>Sentinel</code></p>

<h3 id="toc_11">为什么要手动启动<code>sentinel</code></h3>

<p>需要说明的一点是，我们可以在<code>CacheCloud</code>中可以直接配置<code>Redis-Sentinel</code>集群，似乎我们直接在<code>CacheCloud</code>中配置好<code>Redis-Sentinel</code>集群，然后将配置好的<code>redis</code>和<code>sentinel</code>添加到<code>codis</code>中，这样更简单。但是这样做是不可行的。</p>

<p>正常情况下，添加了<code>sentinel</code>的<code>codis</code>集群在<code>redis-server</code>主节点宕机后，<code>codis-proxy</code>会自动<code>failover</code>到<code>redis-server</code>从节点。</p>

<p>但是，但是如果<code>codis</code>添加的是通过<code>cachecloud</code>生成的<code>sentinel</code>，则由于<code>cachecloud</code>和<code>codis</code>都对<code>sentinel</code>进行了配置，导致<code>sentinel</code>对同一套主从侦测了两次，在<code>redis-server</code>主节点宕机后，<code>sentinel</code>的<code>cachecloud</code>配置生效，而<code>codis</code>配置不生效，所以<code>codis-proxy</code>无法正常<code>failover</code>。</p>

<p>所以在<code>cachecloud</code>和<code>codis</code>联合使用时，不要在<code>codis</code>中配置<code>cachecloud</code>生成的<code>sentinel</code>。</p>

<p>而为<code>codis</code>单独配置<code>sentinel</code>也很简单。</p>

<h3 id="toc_12">添加sentinel</h3>

<p>首先创建一个简单的配置文件</p>

<pre><code class="language-shell">$ vim sentinel.conf 
port 26379
dir /tmp
protected-mode no # 较早的redis版本不需要该参数
</code></pre>

<p>然后启动<code>sentinel</code></p>

<pre><code class="language-shell">redis-server sentinel.conf --sentinel &amp;
</code></pre>

<p>然后我们添加<code>sentinel</code>的地址添加到<code>codis</code>配置页面的<code>sentinels</code>配置项中即可。</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/12/27</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Codis.html'>Codis</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   <a href="all.html">&laquo; Prev Page</a>  
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="all_2.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>阿勒西的小屋</h1>
                <div class="site-des"></div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Tech.html"><strong>Tech</strong></a>
        
            <a href="%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html"><strong>读书笔记</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15934181114037.html"><超越感觉：批判性思考指南>读书笔记</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934177615172.html">< MySQL Innternals Manual >阅读笔记</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934194114231.html">为InnoDB存储引擎配置内存分配器</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934197733993.html">同步MySQL增量数据到ClickHouse</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934208816740.html">python中的迭代</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>



  














<style type="text/css">
figure{margin: 0;padding: 0;}
figcaption{text-align:center;}

/* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    text-shadow: 0 1px white;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
    
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
    text-shadow: none;
    background:#b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
    text-shadow: none;
    background: #b3d4fc;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background: #F7F7F7;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: slategray;
}

.token.punctuation {
    color: #999;
}

.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #9a6e3a;
    background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #07a;
}

.token.function,
.token.class-name {
    color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
    color: #e90;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>



  </body>
</html>
