<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Tech - 阿勒西的小屋
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="阿勒西的小屋" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
 
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 阿勒西的小屋</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="Tech.html">Tech</a></li>
        
            <li><a href="%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">读书笔记</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15934177615172.html">
                
                  <h1>< MySQL Innternals Manual >阅读笔记</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>
<a href="#toc_0">Chapter 1 A Guided Tour Of The MySQL Source Code</a>
<ul>
<li>
<a href="#toc_1">1.1 Getting the Source Tree</a>
</li>
<li>
<a href="#toc_2">1.2 The Major Directories</a>
<ul>
<li>
<a href="#toc_3">1.2.1 Major Directories: BUILD</a>
<ul>
<li>
<a href="#toc_4">1.2.1.1 GNU Debugger</a>
</li>
<li>
<a href="#toc_5">1.2.1.2 Running a Test with the Debugger</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">Chapter 1 A Guided Tour Of The MySQL Source Code</h2>

<p>这一章主要是讲MySQL源码的各个目录和其作用</p>

<h3 id="toc_1">1.1 Getting the Source Tree</h3>

<ol>
<li><p>从GitHub克隆MySQL源码</p>
<pre><code class="language-shell">me@mymachine:~$ git clone https://github.com/mysql/mysql-server.git 
# 在国内可以使用镜像, 速度会快一点<br/>
git clone https://github.com.cnpmjs.org/mysql/mysql-server.git
</code></pre></li>
<li><p>在mysql-server的目录中可以查看源码的目录结构</p>
<pre><code class="language-shell">me@mymachine:~$ cd mysql-server
me@mymachine:~/mysql-server$ ls<br/>
BUILD            COPYING             libmysqld    regex          tests<br/>
BUILD-CMAKE      dbug                libservices  scripts        unittest<br/>
client           Docs                man          sql            VERSION<br/>
cmake            extra               mysql-test   sql-bench      vio<br/>
CMakeLists.txt   include             mysys        sql-common     win<br/>
cmd-line-utils   INSTALL-SOURCE      packaging    storage        zlib<br/>
config.h.cmake   INSTALL-WIN-SOURCE  plugin       strings<br/>
configure.cmake  libmysql            README       support-files
</code></pre></li>
<li><p>使用<code>git branch -r</code>查看“remote-tracking”分支</p>
<pre><code class="language-shell">~/mysql-server$ git branch -r
origin/5.5<br/>
origin/5.6<br/>
origin/5.7<br/>
origin/HEAD -&gt; origin/5.7
</code></pre></li>
<li><p>使用<code>get branch</code>查看当前分支</p>
<pre><code class="language-shell">~/mysql-server$ git branch
* 5.7
</code></pre></li>
<li><p>使用<code>git checkout</code>迁出指定分支</p>
<pre><code class="language-shell">~/mysql-server$ git checkout 5.6
Branch 5.6 set up to track remote branch 5.6 from origin.<br/>
Switched to a new branch &#39;5.6&#39;<br/>
me@mymachine:~/mysql-server$ git checkout 5.5<br/>
Branch 5.5 set up to track remote branch 5.5 from origin.<br/>
Switched to a new branch &#39;5.5&#39;
</code></pre></li>
<li><p>再次使用<code>git branch</code>查看当前的所有分支, 可以看到, 一共有3个分支, 5.5是当前分支</p>
<pre><code class="language-shell">~/mysql-server$ git branch
* 5.5<br/>
5.6<br/>
5.7
</code></pre></li>
</ol>

<h3 id="toc_2">1.2 The Major Directories</h3>

<p>这一章介绍7个主要的目录</p>

<h4 id="toc_3">1.2.1 Major Directories: BUILD</h4>

<p><code>BUILD</code>目录负责编译和连接</p>

<pre><code class="language-shell">shell&gt; ./BUILD/compile-pentium-debug --prefix=$HOME/mysql-bin
</code></pre>

<p>这个命令会调用一个批处理文件生成MySQL的服务端和客户端的可执行程序<br/>
如果缺少相应的依赖包, 会执行失败<br/>
编译完后, 使用以下命令安装</p>

<pre><code class="language-shell">shell&gt; make
shell&gt; make install
shell&gt; $HOME/mysql-bin/scripts/mysql_install_db \
 --basedir=$HOME/mysql-bin \
 --datadir=$HOME/mysql-bin/var
</code></pre>

<h5 id="toc_4">1.2.1.1 GNU Debugger</h5>

<p>推荐通过<a href="http://www.gnu.org/software/gdb/documentation/">gdb(GNU debugger)</a>调试运行中的程序<br/>
也可以使用图形化的调试工具<a href="http://www.gnu.org/software/ddd/manual/">DDD(Data Display Debugger)</a><br/>
使用以下命令调试mysqld服务</p>

<pre><code class="language-shell">shell&gt; ddd --gdb --args \
     $HOME/mysql-bin/libexec/mysqld \
     --basedir=$HOME/mysql-bin \
     --datadir=$HOME/mysql-bin/var\
     --skip-networking
</code></pre>

<h5 id="toc_5">1.2.1.2 Running a Test with the Debugger</h5>

<p>通过嵌入模式运行一个名为<code>some.test</code>的测试:</p>

<ol>
<li>运行<code>libmysqld/examples/test_run --gdb some.test</code>命令来创建一个<code>libmysqld/examples/test-gdbinit</code>文件, 这个文件包含了<code>mysqltest</code>所需的参数</li>
<li></li>
</ol>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/06/29</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Tech.html'>Tech</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934194114231.html">
                
                  <h1>为InnoDB存储引擎配置内存分配器</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>这是一篇MySQL官方文档的翻译，是我在查阅InnoDB额外内存池相关资料时找到的</p>
</blockquote>

<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-performance-use_sys_malloc.html">原文链接</a></p>

<h2 id="toc_0">14.6.4 Configuring the Memory Allocator for InnoDB</h2>

<blockquote>
<p>14.6.4 为InnoDB存储引擎配置内存分配器</p>
</blockquote>

<p>​When InnoDB was developed, the memory allocators supplied with operating systems and run-time libraries were often lacking in performance and scalability. At that time, there were no memory allocator libraries tuned for multi-core CPUs. Therefore, InnoDB implemented its own memory allocator in the mem subsystem. This allocator is guarded by a single mutex, which may become a bottleneck. InnoDB also implements a wrapper interface around the system allocator (malloc and free) that is likewise guarded by a single mutex.</p>

<blockquote>
<p>在InnoDB存储引擎被开发时，操作系统和运行时库所提供的内存分配器在性能和扩展性上都表现欠佳。当时并没有针对多核CPU调优的内存分配器库。因此，InnoDB在mem子系统中自己实现了一个内存分配器。这个分配器被一个单一的互斥锁保护着，而这则可能会导致瓶颈。InnoDB也实现了一个基于系统分配器（malloc和free）的包装接口，同样的，也被单一互斥锁保护着。</p>
</blockquote>

<p>Today, as multi-core systems have become more widely available, and as operating systems have matured, significant improvements have been made in the memory allocators provided with operating systems. These new memory allocators perform better and are more scalable than they were in the past. Most workloads, especially those where memory is frequently allocated and released (such as multi-table joins), benefit from using a more highly tuned memory allocator as opposed to the internal, InnoDB-specific memory allocator.</p>

<blockquote>
<p>现在，随着多核系统的广泛应用和操作系统的不断成熟，操作系统所提供的内存分配器也取得了重大的进步。新的内存分配器在性能和扩展性方面都比之前的要更加优异。在大多数的工作负载（尤其是需要频繁的分配和释放内存的）场景下，使用经过高度调优的内存分配器要比使用InnoDB特定的内置的内存分配器效果更好。</p>
</blockquote>

<p>​You can control whether InnoDB uses its own memory allocator or an allocator of the operating system, by setting the value of the system configuration parameterinnodb_use_sys_malloc in the MySQL option file (my.cnf or my.ini). If set to ON or 1 (the default), InnoDB uses the malloc and freefunctions of the underlying system rather than manage memory pools itself. This parameter is not dynamic, and takes effect only when the system is started. To continue to use the InnoDB memory allocator, set innodb_use_sys_malloc to 0.</p>

<blockquote>
<p>你可以通过配置MySQL配置文件（my.cnf or my.ini）中的innodb_use_sys_malloc参数来控制InnoDB是使用自带的内存分配器还是使用操作系统提供的内存分配器。如果参数被设置为ON或者1（这也是默认值），InnoDB会使用当前系统下的malloc和free函数，而不是维护一个自己的内存池。这个参数并非是动态的，它会随着系统的启动而生效。将innodb_use_sys_malloc设置为0，则会继续使用InnoDB的内存分配器。</p>
</blockquote>

<p>​When the InnoDB memory allocator is disabled, InnoDB ignores the value of the parameter innodb_additional_mem_pool_size. The InnoDB memory allocator uses an additional memory pool for satisfying allocation requests without having to fall back to the system memory allocator. When the InnoDB memory allocator is disabled, all such allocation requests are fulfilled by the system memory allocator.</p>

<blockquote>
<p>当InnoDB内存分配器被关闭是，InnoDB会忽略innodb_additional_mem_pool_size参数的值。InnoDB内存分配器使用一个额外的内存池来满足分配请求，而不必依赖于系统的内存分配器。而当InnoDB内存分配器不可用时，所有的分配请求都将由系统的内存分配器来满足。</p>
</blockquote>

<p>​On Unix-like systems that use dynamic linking, replacing the memory allocator may be as easy as making the environment variable LD_PRELOAD or LD_LIBRARY_PATH point to the dynamic library that implements the allocator. On other systems, some relinking may be necessary. Please refer to the documentation of the memory allocator library of your choice.</p>

<blockquote>
<p>在使用动态链接的类Unix系统上，替换内存分配器很简单，只要将环境变量LD_PRELOAD or LD_LIBRARY_PATH指向实现了分配器的动态库就行。在其他系统中则需要重新连接。请参考你所选择的内存分配器库的相关文档。</p>
</blockquote>

<p>​Since InnoDB cannot track all memory use when the system memory allocator is used (innodb_use_sys_malloc is ON), the section “BUFFER POOL AND MEMORY” in the output of the SHOW ENGINE INNODB STATUS command only includes the buffer pool statistics in the “Total memory allocated”. Any memory allocated using the mem subsystem or using ut_malloc is excluded.</p>

<blockquote>
<p>当使用系统内存分配器（innodb_use_sys_malloc设为ON）时，InnoDB无法跟踪内存的使用，因此在使用SHOW ENGINE INNODB STATUS命令查看输出中的BUFFER POOL AND MEMORY信息时“Total memory allocated”仅包含了缓冲池（buffer pool）的统计。而没有使用mem子系统或者ut_malloc的内存分配。</p>
</blockquote>

<p>Note</p>

<p>​innodb_use_sys_malloc and innodb_additional_mem_pool_size were deprecated in MySQL 5.6 and removed in MySQL 5.7.</p>

<blockquote>
<p>innodb_use_sys_malloc和innodb_additional_mem_pool_size在MySQL 5.6中被弃用，在MySQL 5.7中被移除。</p>
</blockquote>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/03/22</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Tech.html'>Tech</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934197733993.html">
                
                  <h1>同步MySQL增量数据到ClickHouse</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>
<a href="#toc_0">安装</a>
<ul>
<li>
<a href="#toc_1">kafka</a>
</li>
<li>
<a href="#toc_2">Maxwell</a>
</li>
<li>
<a href="#toc_3">clickhouse</a>
</li>
</ul>
</li>
<li>
<a href="#toc_4">同步数据</a>
<ul>
<li>
<a href="#toc_5">使用Python从kafka导入数据到clickhouse</a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">安装</h2>

<h3 id="toc_1">kafka</h3>

<p><code>kafka</code>的安装只需要下载、解压、启动即可</p>

<pre><code class="language-shell">wget http://mirror.its.dal.ca/apache/kafka/1.0.0/kafka_2.11-1.0.0.tgz
tar -zxf kafka_2.11-1.0.0.tgz 
cd kafka_2.11-1.0.0/
</code></pre>

<p><code>kafka</code>需要依赖于<code>zk</code>，<code>zk</code>可以直接使用<code>kafka</code>安装包里自带的<code>zk</code>。</p>

<pre><code class="language-shell">bin/zookeeper-server-start.sh config/zookeeper.properties &amp;
</code></pre>

<p>但是在启动之前，我们可能需要先修改一下配置文件<code>config/server.properties</code><br/>
一般需要修改的几个参数有</p>

<pre><code class="language-shell"># kafka broker的id
broker.id=0
# kafka监听的地址
listeners=PLAINTEXT://:9092
# kafka的日志地址
log.dirs=/tmp/kafka-logs
# kafka使用的zk的地址
zookeeper.connect=localhost:2181
</code></pre>

<p>启动<code>broker</code></p>

<pre><code class="language-shell">bin/kafka-server-start.sh config/server.properties &amp;
</code></pre>

<p>查看<code>kafka</code>是否启动了</p>

<pre><code class="language-shell">$ jps
1240 QuorumPeerMain
1817 Jps
1518 Kafka
</code></pre>

<p>上面的<code>QuorumPeerMain</code>就是<code>zk</code>，<code>Kafka</code>就是我们刚才启动的<code>broker</code><br/>
我们还可以在启动两个新<code>broker</code>，但是需要先复制配置文件并修改里面的<code>broker.id</code>、<code>listeners</code>、<code>log.dirs</code>值，使之不冲突</p>

<pre><code class="language-shell">bin/kafka-server-start.sh config/server-1.properties &amp;
bin/kafka-server-start.sh config/server-2.properties &amp;
</code></pre>

<p>然后我们可以测试一些简单的操作<br/>
创建名为<code>test</code>的<code>topic</code>，只有一个分区，一个副本</p>

<pre><code class="language-shell">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --partitons 1 --topic test
</code></pre>

<p>查看<code>topic</code></p>

<pre><code class="language-shell">bin/kafka-topics.sh --list --zookeeper 127.0.0.1:2181
</code></pre>

<p>查看<code>test</code>的分区和副本状态</p>

<pre><code class="language-shell">bin/kafka-topics.sh --describe --zookeeper 127.0.0.1:2181 --topic test
</code></pre>

<p>使用生产者推送消息</p>

<pre><code class="language-shell">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test
</code></pre>

<p>然后打开另一个窗口，使用消费者从开始获取消息</p>

<pre><code class="language-shell">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
</code></pre>

<h3 id="toc_2">Maxwell</h3>

<p>关于<code>Maxwell</code>的相关资料可以直接查看<a href="http://maxwells-daemon.io/">官网</a><br/>
下载并解压<code>maxwell</code></p>

<pre><code class="language-shell">wget https://github.com/zendesk/maxwell/releases/download/v1.13.2/maxwell-1.13.2.tar.gz
tar -zxf maxwell-1.13.2.tar.gz
cd maxwell-1.13.2
</code></pre>

<p>在<code>mysql</code>中创建一个<code>maxwell</code>账户</p>

<pre><code class="language-sql">GRANT ALL on maxwell.* to &#39;maxwell&#39;@&#39;%&#39; identified by &#39;XXXXXX&#39;;
GRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to &#39;maxwell&#39;@&#39;%&#39;;
</code></pre>

<p>拷贝一份配置文件的模板<code>config.properties.example</code></p>

<pre><code class="language-shell">cp config.properties.example config.properties
</code></pre>

<p>然后编辑配置文件，并将<code>ddl操作</code>发送给单独的<code>topic</code></p>

<pre><code class="language-ini"># tl;dr config
log_level=info
producer=kafka
kafka.bootstrap.servers=localhost:9092

# mysql login info
host=localhost
user=maxwell
password=maxwell

######### output format stuff ###############
# 记录binlog position（默认关闭）
output_binlog_position=true
# 记录gtid（默认关闭）
output_gtid_position=true
# 记录空值字段（默认开启）
output_nulls=true
# 记录server_id（默认关闭）
output_server_id=true
# 记录thread_id（默认关闭）
output_thread_id=true
# 记录原始的SQL语句，需要在mysql中打开参数&quot;binlog_rows_query_log_events&quot; must be enabled&quot;（默认关闭）
output_row_query=true
# 记录commit和xid信息（默认开启）
output_commit_info=true
# 记录ddl操作
output_ddl=true

######### kafka stuff ###############
# binlog日志解析到的topic
kafka_topic=maxwell
# ddl操作的binlog日志解析到的topic，需要开启前面的output_ddl选项
ddl_kafka_topic=maxwell_ddl
</code></pre>

<p>为<code>maxwell</code>创建<code>topic</code></p>

<pre><code class="language-shell">bin/kafka-topics.sh --zookeeper 127.0.0.1:2181 --create --topic maxwell --partitions 20 --replication-factor 1
bin/kafka-topics.sh --zookeeper 127.0.0.1:2181 --create --topic maxwell_ddl --partitions 1 --replication-factor 1
</code></pre>

<p>使用配置文件启动<code>maxwell</code></p>

<pre><code class="language-shell">bin/maxwell --config=config.properties &amp;
</code></pre>

<p>现在我们可以修改数据库的数据，然后在kafka目录下观察队列中的数据</p>

<pre><code class="language-shell"># 在kafka中查看binlog的变化
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic maxwell --from-beginning
# 在kafka中查看ddl的binlog的变化
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic maxwell_ddl --from-beginning
</code></pre>

<h3 id="toc_3">clickhouse</h3>

<p><a href="https://clickhouse.yandex/#quick-start">官方文档</a>直接提供了使用<code>apt-get</code>安装的方法<br/>
但是官方并没有提供<code>yum</code>的安装方法，我这里使用了<a href="https://github.com/red-soft-ru/clickhouse-rpm">第三方</a>提供的仓库，</p>

<pre><code class="language-shell"># 安装yum-config-manager程序
yum install yum-utils
# centos 6 的仓库
yum-config-manager --add-repo http://repo.red-soft.biz/repos/clickhouse/repo/clickhouse-el6.repo
# centos 7 的仓库
yum-config-manager --add-repo http://repo.red-soft.biz/repos/clickhouse/repo/clickhouse-el7.repo
# 安装软件包
yum install clickhouse-server clickhouse-client clickhouse-server-common clickhouse-compressor
</code></pre>

<p>修改配置文件<code>vim /etc/clickhouse-server/config.xml</code></p>

<pre><code class="language-shell">...
&lt;!-- 修改监听IP --&gt;
&lt;listen_host&gt;::&lt;/listen_host&gt;
   &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt;

...

   &lt;!-- 修改数据路径 --&gt;
   &lt;path&gt;/data/clickhouse/&lt;/path&gt;
   &lt;tmp_path&gt;/data/clickhouse/tmp/&lt;/tmp_path&gt;
...
</code></pre>

<p>启动服务</p>

<pre><code class="language-shell">service clickhouse-server start
</code></pre>

<p>进入<code>clickhouse</code></p>

<pre><code class="language-shell">clickhouse-client -mn
</code></pre>

<p>创建</p>

<pre><code class="language-sql">CREATE TABLE data_record.row_record ( 
    r_date Date,  
    database String,  
    table String,  
    type String,  
    ts Int64,  
    xid Int64,  
    position String,  
    gtid Nullable(String),  
    server_id Int64,  
    thread_id Int64,  
    data String,  
    old String) ENGINE = MergeTree(r_date, (r_date, database, table), 8192)
</code></pre>

<h2 id="toc_4">同步数据</h2>

<h3 id="toc_5">使用Python从kafka导入数据到clickhouse</h3>

<p>下面是一个简单的例子</p>

<pre><code class="language-python"># -*- coding: utf-8 -*-
from confluent_kafka import Consumer, KafkaError
import clickhouse_driver
import logging
import json
import datetime


class ChWriter(object):
    def __init__(self, setting):
        self.conn = clickhouse_driver.Client(**setting)

    def ch_insert(self, sql, dicts):
        &quot;&quot;&quot;插入数据&quot;&quot;&quot;
        self.conn.execute(sql, dicts)


def prefunc(data):
    data[&#39;r_date&#39;] = datetime.datetime.fromtimestamp(data[&#39;ts&#39;]).date()
    print(&#39;timestamp:&#39;, data[&#39;ts&#39;], &#39;\n&#39;, &#39;date:&#39;, data[&#39;r_date&#39;])
    data[&#39;gtid&#39;] = None
    data[&#39;data&#39;] = str(data[&#39;data&#39;])
    if &#39;position&#39; not in data: data[&#39;position&#39;] = &#39;&#39;
    if &#39;server_id&#39; not in data: data[&#39;server_id&#39;] = 0
    if &#39;thread_id&#39; not in data: data[&#39;thread_id&#39;] = 0
    if data[&#39;type&#39;] == &#39;update&#39;:
        data[&#39;old&#39;] = str(data[&#39;old&#39;])
    else:
        data[&#39;old&#39;] = &#39;&#39;
    return data


if __name__ == &quot;__main__&quot;:
    # logging.basicConfig(filename=&#39;example.log&#39;, level=logging.DEBUG)
    logging.basicConfig(level=logging.DEBUG, format=&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;)

    ch_setting = {
        &#39;host&#39;: &#39;10.10.4.103&#39;,
        &#39;port&#39;: 9000,
        &#39;user&#39;: &#39;default&#39;,
        &#39;password&#39;: &#39;&#39;,
    }

    chw = ChWriter(ch_setting)
    sql = &quot;INSERT INTO `data_record`.`row_record`(r_date,database,table,type,ts,xid,position,gtid,server_id,thread_id,data,old) VALUES&quot;

    c = Consumer({&#39;bootstrap.servers&#39;: &#39;10.10.4.103:9093&#39;, &#39;group.id&#39;: &#39;0&#39;,
                  &#39;default.topic.config&#39;: {&#39;auto.offset.reset&#39;: &#39;smallest&#39;}})
    c.subscribe([&#39;maxwell&#39;])
    running = True
    while running:
        msg = c.poll()
        if not msg.error():
            r_data = msg.value().decode(&#39;utf-8&#39;)
            print(&#39;Received message: %s&#39; % r_data)
            data = json.loads(r_data)
            prefunc(data)
            chw.ch_insert(sql, [data])
        elif msg.error().code() != KafkaError._PARTITION_EOF:
            print(msg.error())
            running = False
    c.close()
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/02/26</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Tech.html'>Tech</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934208816740.html">
                
                  <h1>python中的迭代</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>在<code>python</code>中，迭代是一个很重要的概念，当我们使用各种循环的时候，我们就会用到这个概念，比如：<code>for循环</code>。</p>

<p>而<code>for</code>是如何工作的？自己如何在类中实现迭代？下面我们就来了解一下：</p>

<p>首先，我们要了解几个概念：<code>迭代</code>、<code>可迭代对象</code>、<code>迭代器</code>。</p>

<p><code>迭代</code>是一种惰性获取数据的方式，每次返回一个值。</p>

<p><code>可迭代对象</code>，按照字面意思就是可迭代的对象，在<code>Python</code>中，一个可迭代对象都可以通过内置函数<code>iter()</code>返回一个迭代器。而<code>iter()</code>函数则会检查对象中有没有实现<code>__iter__()</code>函数，如果有则调用<code>__iter__()</code>返回一个可迭代对象，如果没有，则检查是否实现了<code>__getitem__()</code>函数，如果有则根据__getitem__()函数生成一个迭代器，按顺序获取元素，如果都没有，则抛出异常，表明对象不可迭代。</p>

<p><code>迭代器</code>实现了<code>__next__()</code>函数，可以返回下一个元素，如果没有下一个元素则返回<code>StopIteration</code>的异常。</p>

<p>而我们在提起迭代器的时候，通常还会提起另一个概念<code>生成器</code>。</p>

<p><code>生成器</code>是一种特殊的迭代器，它能够更优雅的实现迭代器的功能。生成器的特征是使用yield关键字，而不使用<code>__iter__()</code>和<code>__next__()</code>内置函数。</p>

<pre><code class="language-python"># 返回从0开始整数的累加值，大于100结束
# 迭代器
class myIter():
    def __init__(self):
        self.count = 0
        self.sum = 0

    def __iter__(self):
        return self

    def __next__(self):
        self.sum += self.count
        self.count += 1
        return self.sum


if __name__ == &quot;__main__&quot;:
    a = myIter()
    for i in a:
        print(i)
        if i &gt; 100:
            break
</code></pre>

<pre><code class="language-python"># 返回从0开始整数的累加值，大于100结束
# 生成器
def myGen():
    count, sum = 0, 0
    while True:
        yield sum
        count += 1
        sum += count


if __name__ == &quot;__main__&quot;:
    a = myGen()
    for i in a:
        print(i)
        if i &gt; 100:
            break
</code></pre>

<p>我们可以看到使用<code>生成器</code>实现的代码看起来更简介，更pythonic。</p>

<p>使用<code>迭代器</code>时我们需要先创建一个类，然后在类里实现<code>__iter__()</code>和<code>__next__()</code>两个内置函数。</p>

<p>而使用<code>生成器</code>时，我们只需要定义一个函数，在函数中使用<code>yield</code>做返回，也不需要<code>return</code>。</p>

<p>同样的还有<code>生成器表达式</code>，它看起来像一个<code>列表表达式</code>，但是它使用的是<code>()</code>而不是<code>[]</code>，并且它返回的是一个<code>生成器对象</code>，而不是<code>列表</code>。</p>

<pre><code class="language-python"># 列表表达式
[x+1 for x in range(10)]
# 生成器表达式
(x+1 for x in range(10))
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/01/23</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python.html'>Python</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15934213696180.html">
                
                  <h1>解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>有时候解决一个问题很简单，但是其中发现问题和深入问题的过程却值得我们反复思考</p>
</blockquote>

<h2 id="toc_0">出现了问题</h2>

<p>最近在测试环境新搭的一套<code>proxysql</code>忽然无法正常登录了，一直提示连接<code>hostgroup</code>超时。</p>

<p>我首先跳过<code>proxysql</code>，直接连接后端的<code>mysql</code>节点，确认是<code>proxysql</code>的问题还是<code>mysql</code>的问题。</p>

<p>但是连接一直处于进行中的状态，不提示登录成功也不提示登录失败。</p>

<h2 id="toc_1">初步判断和尝试解决</h2>

<p>初步判断应该是<code>mysql</code>的连接数被打满了。</p>

<p>使用命令查看连接数</p>

<pre><code class="language-shell">netstat -naplt|grep 6033|wc -l
</code></pre>

<p>连接数显示<code>mysql</code>的连接已经被占满了。</p>

<p>由于后端的<code>mysql</code>节点只通过<code>proxysql</code>来访问，其他的程序并不知道<code>mysql</code>实例的端口号，所以尝试重启<code>proxysql</code>来释放连接。</p>

<p>再次尝试连接后端<code>mysql</code>节点，这次直接提示连接数过多，连接失败。</p>

<p>显然，重启<code>proxysql</code>并没有成功的解决问题。</p>

<h2 id="toc_2">挖掘问题并再次尝试解决</h2>

<p>仔细查看<code>netstat</code>输出的信息。</p>

<p>发现绝大部分的连接都是<code>TIME_WAIT</code>。</p>

<p>之后，通过重启<code>mysql</code>暂时的清理掉了这些连接，但是，首先，重启<code>mysql</code>的成本过高，在线上根本不可行，其次，暂时清理掉<code>TIME_WAIT</code>的连接之后，<code>TIME_WAIT</code>的连接数又很快的涨了上来。这并没有从根本上解决问题。</p>

<p>尝试通过<code>proxysql</code>的参数进行连接数限制，但是，<code>TIME_WAIT</code>状态的连接根本不被计算在<code>proxysql</code>的连接中，无法被限制。</p>

<p>查阅资料暂时解决了问题<br/>
查询了相关资料后，发现可以通过修改<code>Linux</code>内核参数来优化<code>TCP连接</code>。</p>

<p>编辑<code>/etc/sysctl.conf</code></p>

<pre><code class="language-ini"># 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
net.ipv4.tcp_tw_reuse = 1 
# 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
net.ipv4.tcp_tw_recycle = 1 
# 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。
net.ipv4.tcp_fin_timeout = 30 
# 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。
net.ipv4.tcp_max_tw_buckets = 400
</code></pre>

<p>通过开启<code>tcp复用</code>，<code>tcp快速回收</code>，修改<code>tcp fin超时时间</code>依然无法降低<code>TIME_WAIT</code>连接的数量。</p>

<p>最后，通过修改<code>TIME_WAIT</code>的最大保持数量，将<code>TIME_WAIT</code>的连接数量控制在<code>mysql</code>的最大连接数以内，暂时保证了<code>mysql</code>的可用性。</p>

<p>但是，我们依然并没有从根本解决问题。</p>

<h2 id="toc_3">深入了解TIME_WAIT连接尝试解决问题</h2>

<p>为了解决问题，我们先了解一下<code>TIME_WAIT</code>是什么。</p>

<p><img src="media/15934213696180/15934216027787.jpg" alt="tcp_conn"/></p>

<p>在关闭<code>TCP</code>连接的四次握手中，<code>客户端</code>先向<code>服务器端</code>发送<code>FIN报文</code>，告诉服务器端“我要断开连接了”，服务器端收到<code>FIN</code>后会回复一个<code>ACK</code>，表示收到断开连接的请求，但此时<code>服务器端</code>可能仍有数据未发送完，当服务器将数据发送完成后，<code>服务器端</code>会发送一个<code>FIN报文</code>，表示可以断开连接，<code>客户端</code>接收到<code>FIN报文</code>以后会发送一个<code>ACK报文</code>，此时<code>客户端</code>会发送一个<code>ACK报文</code>，然后<code>客户端</code>进入<code>TIME_WAIT</code>状态，当等待<code>2MSL（两个最大报文段生存时间）</code>之后，如果没有再接收到<code>服务器端</code>的请求，连接就会自动断开。</p>

<p>换句话说，当连接进入<code>TIME_WAIT</code>状态以后，我们不需要做任何事情，也无法做任何事情，我们所能做的唯一的事情就是等待一段时间以后，<code>TIME_WAIT</code>的连接就会自动断开。</p>

<p>所以<code>TIME_WAIT</code>的问题并不是连接没有被释放，而是这些<code>TIME_WAIT</code>的连接被创建的太多了。</p>

<p>由于在该环境中，<code>mysql</code>只有<code>proxysql</code>在连接，所以我尝试修改了一些<code>proxysql</code>中关于连接的参数<code>mysql-free_connections_pct</code>、<code>mysql-max_stmts_per_connection</code>等，但是依然无效。</p>

<h2 id="toc_4">问题解决和总结</h2>

<p>最后，该问题的解决是通过修复<code>mysql</code>中<code>monitor</code>用户而解决的。</p>

<p><code>monitor</code>用户是<code>proxysql</code>用以监控<code>mysql</code>的用户，<code>proxysql</code>会定时调用该用户从<code>mysql</code>中获取数据。而在<code>mysql</code>中该用户其实并没有被正确的创建，虽然在一开始我就从<code>log</code>中发现了这个问题，但是我并不认为这会导致<code>mysql</code>节点不可用，所以就忽略了这问题。但是，没有想到，虽然<code>monitor</code>用户无法正常的连接到<code>mysql</code>，但是会创建一个<code>TIME_WAIT</code>的连接。而且，由于不同的尝试连接，导致连接数过大，造成<code>mysql</code>无法使用。</p>

<p>在解决了问题之后，又通过简单的<code>python</code>程序验证了这一状况。</p>

<pre><code class="language-python">import mysql.connector

for i in range(100):
    try:
        conn1 = mysql.connector.connect(user=&#39;aaa&#39;, password=&#39;aaa&#39;, host=&#39;192.168.100.10&#39;, port=3306)
    except (mysql.connector.errors.ProgrammingError) as e:
        print(i + 1, &quot; : &quot;, e)
print(&quot;the end&quot;)
</code></pre>

<p>在上面的脚本中，使用错误的用户名密码不断地连接数据库。</p>

<p>然后，通过监控<code>TIME_WAIT</code>数量，发现虽然连接都失败了，但是每一次尝试连接都会产生一个<code>TIME_WAIT</code>的连接。</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/01/10</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='ProxySQL.html'>ProxySQL</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="Tech_1.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>阿勒西的小屋</h1>
                <div class="site-des"></div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Tech.html"><strong>Tech</strong></a>
        
            <a href="%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html"><strong>读书笔记</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15934181114037.html"><超越感觉：批判性思考指南>读书笔记</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934177615172.html">< MySQL Innternals Manual >阅读笔记</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934194114231.html">为InnoDB存储引擎配置内存分配器</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934197733993.html">同步MySQL增量数据到ClickHouse</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15934208816740.html">python中的迭代</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>



  














<style type="text/css">
figure{margin: 0;padding: 0;}
figcaption{text-align:center;}

/* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    text-shadow: 0 1px white;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
    
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
    text-shadow: none;
    background:#b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
    text-shadow: none;
    background: #b3d4fc;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background: #F7F7F7;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: slategray;
}

.token.punctuation {
    color: #999;
}

.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #9a6e3a;
    background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #07a;
}

.token.function,
.token.class-name {
    color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
    color: #e90;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>



  </body>
</html>
