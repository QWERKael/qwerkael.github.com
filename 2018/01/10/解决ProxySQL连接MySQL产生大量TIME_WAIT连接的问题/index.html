<!DOCTYPE html><html lang="Chinese"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="QWERKael's Blog"><title>解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题 | QWERKael's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</h1><a id="logo" href="/.">QWERKael's Blog</a><p class="description">Was macht mich nicht umbringt, macht mich stärker!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</h1><div class="post-meta">Jan 10, 2018</div><div class="post-content"><blockquote>
<p>有时候解决一个问题很简单，但是其中发现问题和深入问题的过程却值得我们反复思考</p>
</blockquote>
<h3 id="出现了问题"><a href="#出现了问题" class="headerlink" title="出现了问题"></a>出现了问题</h3><p>最近在测试环境新搭的一套<code>proxysql</code>忽然无法正常登录了，一直提示连接<code>hostgroup</code>超时。</p>
<p>我首先跳过<code>proxysql</code>，直接连接后端的<code>mysql</code>节点，确认是<code>proxysql</code>的问题还是<code>mysql</code>的问题。</p>
<p>但是连接一直处于进行中的状态，不提示登录成功也不提示登录失败。</p>
<h3 id="初步判断和尝试解决"><a href="#初步判断和尝试解决" class="headerlink" title="初步判断和尝试解决"></a>初步判断和尝试解决</h3><p>初步判断应该是<code>mysql</code>的连接数被打满了。</p>
<p>使用命令查看连接数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -naplt|grep 6033|wc -l</span><br></pre></td></tr></table></figure>
<p>连接数显示<code>mysql</code>的连接已经被占满了。</p>
<p>由于后端的<code>mysql</code>节点只通过<code>proxysql</code>来访问，其他的程序并不知道<code>mysql</code>实例的端口号，所以尝试重启<code>proxysql</code>来释放连接。</p>
<p>再次尝试连接后端<code>mysql</code>节点，这次直接提示连接数过多，连接失败。</p>
<p>显然，重启<code>proxysql</code>并没有成功的解决问题。</p>
<h3 id="挖掘问题并再次尝试解决"><a href="#挖掘问题并再次尝试解决" class="headerlink" title="挖掘问题并再次尝试解决"></a>挖掘问题并再次尝试解决</h3><p>仔细查看<code>netstat</code>输出的信息。</p>
<p>发现绝大部分的连接都是<code>TIME_WAIT</code>。</p>
<p>之后，通过重启<code>mysql</code>暂时的清理掉了这些连接，但是，首先，重启<code>mysql</code>的成本过高，在线上根本不可行，其次，暂时清理掉<code>TIME_WAIT</code>的连接之后，<code>TIME_WAIT</code>的连接数又很快的涨了上来。这并没有从根本上解决问题。</p>
<p>尝试通过<code>proxysql</code>的参数进行连接数限制，但是，<code>TIME_WAIT</code>状态的连接根本不被计算在<code>proxysql</code>的连接中，无法被限制。</p>
<h3 id="查阅资料暂时解决了问题"><a href="#查阅资料暂时解决了问题" class="headerlink" title="查阅资料暂时解决了问题"></a>查阅资料暂时解决了问题</h3><p>查询了相关资料后，发现可以通过修改<code>Linux内核参数</code>来优化<code>TCP连接</code>。</p>
<p>编辑<code>/etc/sysctl.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1 </span><br><span class="line"><span class="meta">#</span> 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 </span><br><span class="line"><span class="meta">#</span> 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30 </span><br><span class="line"><span class="meta">#</span> 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 400</span><br></pre></td></tr></table></figure>
<p>通过开启<code>tcp复用</code>，<code>tcp快速回收</code>，修改<code>tcp fin超时时间</code>依然无法降低<code>TIME_WAIT</code>连接的数量。</p>
<p>最后，通过修改<code>TIME_WAIT</code>的最大保持数量，将<code>TIME_WAIT</code>的连接数量控制在<code>mysql</code>的最大连接数以内，暂时保证了<code>mysql</code>的可用性。</p>
<p>但是，我们依然并没有从根本解决问题。</p>
<h3 id="深入了解TIME-WAIT连接尝试解决问题"><a href="#深入了解TIME-WAIT连接尝试解决问题" class="headerlink" title="深入了解TIME_WAIT连接尝试解决问题"></a>深入了解<code>TIME_WAIT</code>连接尝试解决问题</h3><p>为了解决问题，我们先了解一下<code>TIME_WAIT</code>是什么。</p>
<p><img src="/images/tcp_conn.jpg" alt="tcp_conn"></p>
<p>在关闭<code>TCP</code>连接的四次握手中，<code>客户端</code>先向<code>服务器端</code>发送<code>FIN</code>报文，告诉服务器端“我要断开连接了”，<code>服务器端</code>收到<code>FIN</code>后会回复一个<code>ACK</code>，表示收到断开连接的请求，但此时<code>服务器端</code>可能仍有数据未发送完，当服务器将数据发送完成后，<code>服务器端</code>会发送一个<code>FIN</code>报文，表示可以断开连接，<code>客户端</code>接收到<code>FIN</code>报文以后会发送一个<code>ACK</code>报文，此时<code>客户端</code>会发送一个<code>ACK</code>报文，然后<code>客户端</code>进入<code>TIME_WAIT</code>状态，当等待<code>2MSL（两个最大报文段生存时间）</code>之后，如果没有再接收到<code>服务器端</code>的请求，连接就会自动断开。</p>
<p>换句话说，当连接进入<code>TIME_WAIT</code>状态以后，我们不需要做任何事情，也无法做任何事情，我们所能做的唯一的事情就是等待一段时间以后，<code>TIME_WAIT</code>的连接就会自动断开。</p>
<p>所以<code>TIME_WAIT</code>的问题并不是连接没有被释放，而是这些<code>TIME_WAIT</code>的连接被创建的太多了。</p>
<p>由于在该环境中，<code>mysql</code>只有<code>proxysql</code>在连接，所以我尝试修改了一些<code>proxysql</code>中关于连接的参数<code>mysql-free_connections_pct</code>、<code>mysql-max_stmts_per_connection</code>等，但是依然无效。</p>
<h3 id="问题解决和总结"><a href="#问题解决和总结" class="headerlink" title="问题解决和总结"></a>问题解决和总结</h3><p>最后，该问题的解决是通过修复<code>mysql</code>中<code>monitor</code>用户而解决的。</p>
<p><code>monitor</code>用户是<code>proxysql</code>用以监控<code>mysql</code>的用户，<code>proxysql</code>会定时调用该用户从<code>mysql</code>中获取数据。而在<code>mysql</code>中该用户其实并没有被正确的创建，虽然在一开始我就从<code>log</code>中发现了这个问题，但是我并不认为这会导致<code>mysql</code>节点不可用，所以就忽略了这问题。但是，没有想到，虽然<code>monitor</code>用户无法正常的连接到<code>mysql</code>，但是会创建一个<code>TIME_WAIT</code>的连接。而且，由于不同的尝试连接，导致连接数过大，造成<code>mysql</code>无法使用。</p>
<p>在解决了问题之后，又通过简单的<code>python</code>程序验证了这一状况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mysql.connector</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn1 = mysql.connector.connect(user=<span class="string">'aaa'</span>, password=<span class="string">'aaa'</span>, host=<span class="string">'10.10.6.7'</span>, port=<span class="number">33070</span>)</span><br><span class="line">    <span class="keyword">except</span> (mysql.connector.errors.ProgrammingError) <span class="keyword">as</span> e:</span><br><span class="line">        print(i + <span class="number">1</span>, <span class="string">" : "</span>, e)</span><br><span class="line">print(<span class="string">"the end"</span>)</span><br></pre></td></tr></table></figure>
<p>然后，通过监控<code>TIME_WAIT</code>数量，发现虽然连接都失败了，但是每一次尝试连接都会产生一个<code>TIME_WAIT</code>的连接。</p>
</div><div class="tags"><a href="/tags/proxysql/">proxysql</a><a href="/tags/mysql/">mysql</a><a href="/tags/tcp/">tcp</a><a href="/tags/TIME-WAIT/">TIME_WAIT</a></div><div class="post-nav"><a class="pre" href="/2018/01/23/python中的迭代/">python中的迭代</a><a class="next" href="/2018/01/08/yaourt-pacman加速3连/">yaourt/pacman加速3连</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://qwerkael.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/opentsdb/" style="font-size: 15px;">opentsdb</a> <a href="/tags/时序数据库/" style="font-size: 15px;">时序数据库</a> <a href="/tags/proxysql/" style="font-size: 15px;">proxysql</a> <a href="/tags/maxwell/" style="font-size: 15px;">maxwell</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/clickhouse/" style="font-size: 15px;">clickhouse</a> <a href="/tags/mycat/" style="font-size: 15px;">mycat</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/tilda/" style="font-size: 15px;">tilda</a> <a href="/tags/terminal/" style="font-size: 15px;">terminal</a> <a href="/tags/Linux日常/" style="font-size: 15px;">Linux日常</a> <a href="/tags/Q-A/" style="font-size: 15px;">Q&A</a> <a href="/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/tags/pacman/" style="font-size: 15px;">pacman</a> <a href="/tags/yaourt/" style="font-size: 15px;">yaourt</a> <a href="/tags/cli/" style="font-size: 15px;">cli</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/安装/" style="font-size: 15px;">安装</a> <a href="/tags/buffer-pool/" style="font-size: 15px;">buffer pool</a> <a href="/tags/审计/" style="font-size: 15px;">审计</a> <a href="/tags/权限控制/" style="font-size: 15px;">权限控制</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/codis/" style="font-size: 15px;">codis</a> <a href="/tags/cachecloud/" style="font-size: 15px;">cachecloud</a> <a href="/tags/集群/" style="font-size: 15px;">集群</a> <a href="/tags/安装部署/" style="font-size: 15px;">安装部署</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/字符集/" style="font-size: 15px;">字符集</a> <a href="/tags/乱码/" style="font-size: 15px;">乱码</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/yum/" style="font-size: 15px;">yum</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TIME-WAIT/" style="font-size: 15px;">TIME_WAIT</a> <a href="/tags/proxySQL/" style="font-size: 15px;">proxySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/22/为InnoDB存储引擎配置内存分配器/">为InnoDB存储引擎配置内存分配器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/26/maxwell-kafka-clickhouse/">maxwell + kafka + clickhouse</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/23/python中的迭代/">python中的迭代</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题/">解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/08/yaourt-pacman加速3连/">yaourt/pacman加速3连</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/03/安装合集/">安装合集</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/使用Navicat链接proxysql无法进行用户管理/">使用Navicat链接proxysql无法进行用户管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/使用cachecloud和codis搭建redis环境/">使用cachecloud和codis搭建redis环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/OpenTSDB-的安装与部署/">OpenTSDB 的安装与部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/tilda-无法设置透明模式/">tilda 无法设置透明模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://www.percona.com" title="Percona官网" target="_blank">Percona官网</a><ul></ul><a href="http://mysql.taobao.org/monthly/" title="淘宝内核月报" target="_blank">淘宝内核月报</a><ul></ul><a href="https://yandex.com/blog/clickhouse" title="ClickHouse Blog" target="_blank">ClickHouse Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">QWERKael's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>