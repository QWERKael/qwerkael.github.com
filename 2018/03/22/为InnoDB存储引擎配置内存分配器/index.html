<!DOCTYPE html><html lang="Chinese"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="QWERKael's Blog"><title>为InnoDB存储引擎配置内存分配器 | QWERKael's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">为InnoDB存储引擎配置内存分配器</h1><a id="logo" href="/.">QWERKael's Blog</a><p class="description">Was macht mich nicht umbringt, macht mich stärker!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">为InnoDB存储引擎配置内存分配器</h1><div class="post-meta">Mar 22, 2018</div><div class="post-content"><blockquote>
<p>这是一篇MySQL官方文档的翻译，是我在查阅InnoDB额外内存池相关资料时找到的</p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-performance-use_sys_malloc.html" target="_blank" rel="noopener">原文链接</a></p>
</blockquote>
<h3 id="14-6-4-Configuring-the-Memory-Allocator-for-InnoDB"><a href="#14-6-4-Configuring-the-Memory-Allocator-for-InnoDB" class="headerlink" title="14.6.4 Configuring the Memory Allocator for InnoDB"></a>14.6.4 Configuring the Memory Allocator for InnoDB</h3><blockquote>
<p>14.6.4 为InnoDB存储引擎配置内存分配器</p>
</blockquote>
<p>​      When <code>InnoDB</code> was developed, the memory allocators supplied with operating systems and run-time libraries      were often lacking in performance and scalability. At that time, there were no memory allocator libraries tuned for multi-core CPUs. Therefore, <code>InnoDB</code> implemented its own memory allocator in the <code>mem</code> subsystem. This allocator is guarded by a single mutex, which may become a <a href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_bottleneck" target="_blank" rel="noopener">bottleneck</a>. <code>InnoDB</code> also implements a wrapper interface around the system allocator (<code>malloc</code> and <code>free</code>) that is likewise guarded by a single mutex. </p>
<blockquote>
<p>在InnoDB存储引擎被开发时，操作系统和运行时库所提供的内存分配器在性能和扩展性上都表现欠佳。当时并没有针对多核CPU调优的内存分配器库。因此，InnoDB在<code>mem</code>子系统中自己实现了一个内存分配器。这个分配器被一个单一的互斥锁保护着，而这则可能会导致瓶颈。InnoDB也实现了一个基于系统分配器（malloc和free）的包装接口，同样的，也被单一互斥锁保护着。</p>
</blockquote>
<p>​      Today, as multi-core systems have become more widely available, and as operating systems have matured, significant improvements have been made in the memory allocators provided with operating systems. These new memory allocators perform better and are more scalable than they were in the past. Most workloads, especially those where memory is frequently allocated and released (such as multi-table joins), benefit from using a more highly tuned memory allocator as opposed to the internal, <code>InnoDB</code>-specific memory allocator.    </p>
<blockquote>
<p>现在，随着多核系统的广泛应用和操作系统的不断成熟，操作系统所提供的内存分配器也取得了重大的进步。新的内存分配器在性能和扩展性方面都比之前的要更加优异。在大多数的工作负载（尤其是需要频繁的分配和释放内存的）场景下，使用经过高度调优的内存分配器要比使用InnoDB特定的内置的内存分配器效果更好。</p>
</blockquote>
<p>​      You can control whether <code>InnoDB</code> uses its own memory allocator or an allocator of the operating system, by      setting the value of the system configuration parameter<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_use_sys_malloc" target="_blank" rel="noopener"><code>innodb_use_sys_malloc</code></a> in the MySQL option file (<code>my.cnf</code> or <code>my.ini</code>). If set to <code>ON</code> or <code>1</code> (the default), <code>InnoDB</code> uses the <code>malloc</code> and <code>free</code>functions of the underlying system rather than manage memory pools itself. This parameter is not dynamic, and takes effect only when the system is started. To continue to use the <code>InnoDB</code> memory allocator, set <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_use_sys_malloc" target="_blank" rel="noopener"><code>innodb_use_sys_malloc</code></a> to <code>0</code>.    </p>
<blockquote>
<p>你可以通过配置MySQL配置文件（<code>my.cnf</code> or <code>my.ini</code>）中的<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_use_sys_malloc" target="_blank" rel="noopener"><code>innodb_use_sys_malloc</code></a>参数来控制InnoDB是使用自带的内存分配器还是使用操作系统提供的内存分配器。如果参数被设置为<code>ON</code>或者<code>1</code>（这也是默认值），InnoDB会使用当前系统下的<code>malloc</code>和<code>free</code>函数，而不是维护一个自己的内存池。这个参数并非是动态的，它会随着系统的启动而生效。将<code>innodb_use_sys_malloc</code>设置为<code>0</code>，则会继续使用InnoDB的内存分配器。</p>
</blockquote>
<p>​      When the <code>InnoDB</code> memory allocator is disabled, <code>InnoDB</code> ignores the value of the parameter <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_additional_mem_pool_size" target="_blank" rel="noopener"><code>innodb_additional_mem_pool_size</code></a>. The <code>InnoDB</code> memory allocator uses an additional memory pool for satisfying allocation requests without having to fall back to the system memory allocator. When the <code>InnoDB</code> memory allocator is disabled, all such allocation requests are fulfilled by the system memory allocator.    </p>
<blockquote>
<p>当InnoDB内存分配器被关闭是，InnoDB会忽略<code>innodb_additional_mem_pool_size</code>参数的值。InnoDB内存分配器使用一个额外的内存池来满足分配请求，而不必依赖于系统的内存分配器。而当InnoDB内存分配器不可用时，所有的分配请求都将由系统的内存分配器来满足。</p>
</blockquote>
<p>​      On Unix-like systems that use dynamic linking, replacing the memory allocator may be as easy as making the environment variable <code>LD_PRELOAD</code> or <code>LD_LIBRARY_PATH</code> point to the dynamic library that implements the allocator. On other systems, some relinking may be necessary. Please refer to the documentation of the memory allocator library of your choice.    </p>
<blockquote>
<p>在使用动态链接的类Unix系统上，替换内存分配器很简单，只要将环境变量<code>LD_PRELOAD</code> or <code>LD_LIBRARY_PATH</code>指向实现了分配器的动态库就行。在其他系统中则需要重新连接。请参考你所选择的内存分配器库的相关文档。</p>
</blockquote>
<p>​      Since <code>InnoDB</code> cannot track all memory use when the system memory allocator is used      (<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_use_sys_malloc" target="_blank" rel="noopener"><code>innodb_use_sys_malloc</code></a> is <code>ON</code>), the section “BUFFER POOL AND MEMORY” in the output of the <code>SHOW ENGINE INNODB STATUS</code> command only includes the buffer pool statistics in the “Total memory allocated”. Any memory allocated using the <code>mem</code> subsystem or using <code>ut_malloc</code> is excluded.</p>
<blockquote>
<p>当使用系统内存分配器（<code>innodb_use_sys_malloc</code>设为<code>ON</code>）时，InnoDB无法跟踪内存的使用，因此在使用<code>SHOW ENGINE INNODB STATUS</code>命令查看输出中的<code>BUFFER POOL AND MEMORY</code>信息时“Total memory allocated”仅包含了缓冲池（buffer pool）的统计。而没有使用<code>mem</code>子系统或者<code>ut_malloc</code>的内存分配。</p>
</blockquote>
<p>Note</p>
<p>​        <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_use_sys_malloc" target="_blank" rel="noopener"><code>innodb_use_sys_malloc</code></a> and <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_additional_mem_pool_size" target="_blank" rel="noopener"><code>innodb_additional_mem_pool_size</code></a> were deprecated in MySQL 5.6 and removed in MySQL 5.7.</p>
<blockquote>
<p><code>innodb_use_sys_malloc</code>和<code>innodb_additional_mem_pool_size</code>在MySQL 5.6中被弃用，在MySQL 5.7中被移除。</p>
</blockquote>
</div><div class="tags"><a href="/tags/mysql/">mysql</a><a href="/tags/翻译/">翻译</a><a href="/tags/innodb/">innodb</a><a href="/tags/buffer-pool/">buffer pool</a></div><div class="post-nav"><a class="next" href="/2018/02/26/maxwell-kafka-clickhouse/">maxwell + kafka + clickhouse</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://qwerkael.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/buffer-pool/" style="font-size: 15px;">buffer pool</a> <a href="/tags/opentsdb/" style="font-size: 15px;">opentsdb</a> <a href="/tags/时序数据库/" style="font-size: 15px;">时序数据库</a> <a href="/tags/maxwell/" style="font-size: 15px;">maxwell</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/clickhouse/" style="font-size: 15px;">clickhouse</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/mycat/" style="font-size: 15px;">mycat</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/tilda/" style="font-size: 15px;">tilda</a> <a href="/tags/terminal/" style="font-size: 15px;">terminal</a> <a href="/tags/Linux日常/" style="font-size: 15px;">Linux日常</a> <a href="/tags/Q-A/" style="font-size: 15px;">Q&A</a> <a href="/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/tags/pacman/" style="font-size: 15px;">pacman</a> <a href="/tags/yaourt/" style="font-size: 15px;">yaourt</a> <a href="/tags/cli/" style="font-size: 15px;">cli</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/安装/" style="font-size: 15px;">安装</a> <a href="/tags/proxysql/" style="font-size: 15px;">proxysql</a> <a href="/tags/权限控制/" style="font-size: 15px;">权限控制</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/codis/" style="font-size: 15px;">codis</a> <a href="/tags/cachecloud/" style="font-size: 15px;">cachecloud</a> <a href="/tags/集群/" style="font-size: 15px;">集群</a> <a href="/tags/安装部署/" style="font-size: 15px;">安装部署</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/yum/" style="font-size: 15px;">yum</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/字符集/" style="font-size: 15px;">字符集</a> <a href="/tags/乱码/" style="font-size: 15px;">乱码</a> <a href="/tags/proxySQL/" style="font-size: 15px;">proxySQL</a> <a href="/tags/审计/" style="font-size: 15px;">审计</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TIME-WAIT/" style="font-size: 15px;">TIME_WAIT</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/22/为InnoDB存储引擎配置内存分配器/">为InnoDB存储引擎配置内存分配器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/26/maxwell-kafka-clickhouse/">maxwell + kafka + clickhouse</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/23/python中的迭代/">python中的迭代</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题/">解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/08/yaourt-pacman加速3连/">yaourt/pacman加速3连</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/03/安装合集/">安装合集</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/使用Navicat链接proxysql无法进行用户管理/">使用Navicat链接proxysql无法进行用户管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/使用cachecloud和codis搭建redis环境/">使用cachecloud和codis搭建redis环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/OpenTSDB-的安装与部署/">OpenTSDB 的安装与部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/tilda-无法设置透明模式/">tilda 无法设置透明模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://www.percona.com" title="Percona官网" target="_blank">Percona官网</a><ul></ul><a href="http://mysql.taobao.org/monthly/" title="淘宝内核月报" target="_blank">淘宝内核月报</a><ul></ul><a href="https://yandex.com/blog/clickhouse" title="ClickHouse Blog" target="_blank">ClickHouse Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">QWERKael's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>