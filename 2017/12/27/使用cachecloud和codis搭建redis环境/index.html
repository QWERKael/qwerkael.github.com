<!DOCTYPE html><html lang="Chinese"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="QWERKael's Blog"><title>使用cachecloud和codis搭建redis环境 | QWERKael's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用cachecloud和codis搭建redis环境</h1><a id="logo" href="/.">QWERKael's Blog</a><p class="description">Was macht mich nicht umbringt, macht mich stärker!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用cachecloud和codis搭建redis环境</h1><div class="post-meta">Dec 27, 2017</div><div class="post-content"><h3 id="简单的介绍："><a href="#简单的介绍：" class="headerlink" title="简单的介绍："></a>简单的介绍：</h3><h4 id="CacheCloud："><a href="#CacheCloud：" class="headerlink" title="CacheCloud："></a><a href="https://github.com/sohutv/cachecloud" target="_blank" rel="noopener"><code>CacheCloud</code></a>：</h4><p><code>CacheCloud</code>是由<code>souhutv</code>开源一套<code>Redis</code>的管理系统，可以帮助我们自动化的搭建和运维<code>Redis</code>，<code>Cachecloud</code>可以自动部署和管理3种形式的<code>Redis</code>方案，包括<code>单实例Redis</code>，<code>Redis+Sentinel</code>以及<code>Redis的原生集群方案Redis Cluster</code></p>
<h4 id="Codis："><a href="#Codis：" class="headerlink" title="Codis："></a><a href="https://github.com/CodisLabs/codis" target="_blank" rel="noopener"><code>Codis</code></a>：</h4><p><code>Codis</code>是由<code>豌豆荚</code>开源的一套<code>Redis</code>集群方案，是通过<code>proxy</code>路由到不同分片来实现的<code>redis集群</code></p>
<h3 id="Codis安装："><a href="#Codis安装：" class="headerlink" title="Codis安装："></a>Codis安装：</h3><h4 id="1-安装Go环境"><a href="#1-安装Go环境" class="headerlink" title="1. 安装Go环境"></a>1. 安装Go环境</h4><p>在Go语言的<a href="https://golang.org/dl/" target="_blank" rel="noopener">下载页面</a>选择一个你要使用的安装包下载。我选择的是1.9.2版本。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://redirector.gvt1.com/edgedl/go/go1.9.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>修改<code>/etc/profile</code>文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=/data/go/</span><br><span class="line">export PATH=$PATH:/$GOROOT/bin</span><br></pre></td></tr></table></figure></p>
<p>重新加载<code>/etc/profile</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>查看Go是否安装成功<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> go version</span><br><span class="line">go version go1.9.2 linux/amd64</span><br></pre></td></tr></table></figure></p>
<h4 id="2-安装Codis"><a href="#2-安装Codis" class="headerlink" title="2. 安装Codis"></a>2. 安装Codis</h4><p>首先我们需要知道<code>GOPATH</code>的路径<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> go env GOPATH</span><br><span class="line">/root/go</span><br></pre></td></tr></table></figure></p>
<p>Go安装成功后，GOPATH会在<code>～/go</code>目录下，我这值我们也可以进行修改，比如，修改为<code>/data/gopath</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export GOPATH=/data/gopath</span><br></pre></td></tr></table></figure></p>
<p>然后我们需要将codis的代码<code>clone</code>到指定的目录下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> mkdir -p $GOPATH/src/github.com/CodisLabs</span><br><span class="line"><span class="meta">$</span> cd $GOPATH/src/github.com/CodisLabs</span><br><span class="line"><span class="meta">$</span> git clone https://github.com/CodisLabs/codis.git -b release3.2</span><br></pre></td></tr></table></figure></p>
<p>获取到源码后，我们只需要<code>make</code>一下就可以了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cd codis</span><br><span class="line"><span class="meta">$</span> make</span><br><span class="line">make -j4 -C extern/redis-3.2.11/</span><br><span class="line">make[1]: 进入目录“/data/gopath/src/github.com/CodisLabs/codis/extern/redis-3.2.11”</span><br><span class="line">cd src &amp;&amp; make all</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>在这个过程中你可能需要安装一些工具，比如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall "Development Tools"</span><br></pre></td></tr></table></figure></p>
<p>在安装过程中可能会遇到如下的错误</p>
<blockquote>
<p>zmalloc.h:50:31: 致命错误：jemalloc/jemalloc.h：没有那个文件或目录</p>
</blockquote>
<p>这是因为没有找到<code>jemalloc</code>内存管理器的缘故，<br>我们可以在编译的时候指定其他的内存管理<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make MALLOC=libc</span><br></pre></td></tr></table></figure></p>
<p>但是相比<code>jemalloc</code>，其他的内存管理器可能会造成更多的内存碎片（<code>mem_fragmentation_ratio</code>）<br>当然，为了更好的性能，我们自然会选择<code>jemalloc</code>，那么我们就需要安装<code>jemalloc</code>了，但是如果我们现在使用<code>yum</code>安装，可以依然会编译codis报错，因为<code>jemalloc</code>没有被安装到指定的目录，而在redis的安装包里redis自己就为我们提供一个<code>deps</code>目录，里面就有<code>jemalloc</code>和其他一些依赖的安装包。<br>但是codis的目录下为我们提供了多个版本的redis，我们需要使用那个呢？<br>刚才我们在<code>make</code>的时候，第一行输出是<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j4 -C extern/redis-3.2.11/</span><br></pre></td></tr></table></figure></p>
<p>这里我们就可以进入该目录，直接编译<code>deps</code>下的所有依赖<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd extern/redis-3.2.11/deps</span><br><span class="line">make hiredis jemalloc linenoise lua geohash-int</span><br></pre></td></tr></table></figure></p>
<p>再次回到原目录，编译成功</p>
<h3 id="启动Codis："><a href="#启动Codis：" class="headerlink" title="启动Codis："></a>启动Codis：</h3><p>启动<code>Codis</code>会用到zk或者etctd，这里我使用的是zk</p>
<h4 id="安装JDK和ZOOKEEPER"><a href="#安装JDK和ZOOKEEPER" class="headerlink" title="安装JDK和ZOOKEEPER"></a>安装JDK和ZOOKEEPER</h4><p><code>JDK</code>可以直接使用<code>yum</code>安装<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br></pre></td></tr></table></figure></p>
<p>安装完<code>JDK</code>记得要配置环境变量，不然可能会导致一些程序不可用<br><code>vim /etc/profile</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>set java environment  </span><br><span class="line">JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.151-1.b12.el6_9.x86_64</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export JAVA_HOME  CLASSPATH  PATH</span><br></pre></td></tr></table></figure></p>
<p>加载一下配置文件<code>source  /etc/profile</code></p>
<p>ZOOKEEPER需要从官网下载安装包，我部署的是单节点的，解压后直接启动就可以<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz</span><br><span class="line">tar -zxf zookeeper-3.4.11.tar.gz</span><br><span class="line">cd zookeeper-3.4.11/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">cd zookeeper-3.4.11/bin</span><br><span class="line">./zkServer.sh start</span><br></pre></td></tr></table></figure></p>
<h4 id="配置与启动"><a href="#配置与启动" class="headerlink" title="配置与启动"></a>配置与启动</h4><p><img src="/images/codis_architecture.png" alt="codis架构图"></p>
<p>如上图，Codis集群架构可以分为几个部分</p>
<p>最核心的是<code>codis-dashboard</code>和<code>codis-proxy</code></p>
<ul>
<li><code>codis-dashboard</code>是<code>codis</code>的集群管理工具，可以管理<code>codis-proxy</code>、<code>codis-server</code>和<code>Redis-sentinel</code></li>
<li><code>codis-proxy</code>负责<code>codis</code>集群中的代理工作，负责将<code>redis</code>命令路由到不同的分片</li>
<li><code>codis-fe</code>是<code>codis-dashboard</code>的<code>web</code>管理界面，可以更方便、更形象的管理集群</li>
<li><code>codis-serer</code>是在<code>redis-server</code>基础上增加了<code>codis</code>相关命令而形成的另一个分支</li>
</ul>
<p>现在我们要启动<code>Codis</code></p>
<p>我们先进入<code>codis</code>的配置文件目录<code>/data/gopath/src/github.com/CodisLabs/codis/config</code>修改<code>codis-dashboard</code>的配置文件，<code>codis-dashboard</code>默认使用<code>filesystem</code>作为外部存储，我们将其修改为<code>zookeeper</code>。</p>
<p>然后将<code>product_name</code>修改为该我们的<code>codis集群</code>的名字，这里我们改成<code>codis-test</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Set Coordinator, only accept "zookeeper" &amp; "etcd" &amp; "filesystem".</span><br><span class="line"><span class="meta">#</span> for zookeeper/etcd, coorinator_auth accept "user:password" </span><br><span class="line"><span class="meta">#</span> Quick Start</span><br><span class="line"><span class="meta">#</span> coordinator_name = "filesystem"</span><br><span class="line"><span class="meta">#</span> coordinator_addr = "/tmp/codis"</span><br><span class="line">coordinator_name = "zookeeper"</span><br><span class="line">coordinator_addr = "127.0.0.1:2181"</span><br><span class="line"><span class="meta">#</span>coordinator_auth = ""</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Set Codis Product Name/Auth.</span><br><span class="line">product_name = "codis-test"</span><br><span class="line">product_auth = ""</span><br></pre></td></tr></table></figure>
<p>现在启动<code>codis-dashboard</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/codis-dashboard --ncpu=4 --config=config/dashboard.toml --log=logs/dashboard.log --log-level=WARN &amp;</span><br></pre></td></tr></table></figure>
<p>这里我新建了一个<code>logs</code>目录来存放日志</p>
<p><code>codis-proxy</code>也有相应的配置文件，这里我只是简单的修改了一下<code>product_name</code>，然后启动相关的服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 启动 codis-proxy</span><br><span class="line">nohup ./bin/codis-proxy --ncpu=4 --config=config/proxy.toml --log=logs/proxy.log --log-level=WARN &amp;</span><br><span class="line"><span class="meta">#</span> 启动 codis-fe，这里监听的是8080端口</span><br><span class="line">nohup ./bin/codis-fe --ncpu=4 --log=logs/fe.log --log-level=WARN --zookeeper=127.0.0.1:2181 --listen=0.0.0.0:8080 &amp;</span><br></pre></td></tr></table></figure>
<p>现在我们已经可以访问管理页面了</p>
<p>进入管理界面中，我们先添加一个<code>proxy</code></p>
<p><img src="/images/add_codis_proxy.png" alt="添加codis-proxy"></p>
<p>接下来我们就可以添加<code>codis-server</code>和<code>sentinel</code>了，但是在那之前，我们先安装一下<code>CacheCloud</code></p>
<h3 id="安装CacheCloud："><a href="#安装CacheCloud：" class="headerlink" title="安装CacheCloud："></a>安装CacheCloud：</h3><p>我们先从<del>gayhub</del> github上 的获取源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/sohutv/cachecloud.git</span><br></pre></td></tr></table></figure>
<p>由于程序需要用到<code>maven</code>，我们需要先安装<code>maven</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://repos.fedorapeople.org/repos/dchen/apache-maven/epel-apache-maven.repo -O /etc/yum.repos.d/epel-apache-maven.repo</span><br><span class="line">yum -y install apache-maven</span><br></pre></td></tr></table></figure>
<p>现在我们需要修改一下配置文件，配置一下使用的<code>mysql</code>和监听的端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> vim /opt/cachecloud/cachecloud-open-web/src/main/swap/online.properties</span><br><span class="line">cachecloud.db.url = jdbc:mysql://127.0.0.1:3306/cache-cloud</span><br><span class="line">cachecloud.db.user = admin</span><br><span class="line">cachecloud.db.password = 123456</span><br><span class="line">cachecloud.maxPoolSize = 20</span><br><span class="line"></span><br><span class="line">isClustered = true</span><br><span class="line">isDebug = false</span><br><span class="line">spring-file=classpath:spring/spring-online.xml</span><br><span class="line">log_base=/opt/cachecloud-web/logs</span><br><span class="line">web.port=8585</span><br><span class="line">log.level=WARN</span><br></pre></td></tr></table></figure>
<p>启动<code>cachecloud</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 进入cachecloud的根目录</span><br><span class="line">cd /opt/cachecloud</span><br><span class="line"><span class="meta">#</span> 运行maven</span><br><span class="line">mvn clean compile install -Ponline</span><br><span class="line"><span class="meta">#</span> 新建cachecloud-web目录</span><br><span class="line">mkdir /opt/cachecloud-web</span><br><span class="line"><span class="meta">#</span> 拷贝war包、配置文件和启动脚本</span><br><span class="line">cp /opt/cachecloud/cachecloud-open-web/target/cachecloud-open-web-1.0-SNAPSHOT.war /opt/cachecloud-web</span><br><span class="line">cp /opt/cachecloud/cachecloud-open-web/src/main/resources/cachecloud-web.conf /opt/cachecloud-web</span><br><span class="line">cp /opt/cachecloud/script/st*.sh /opt/cachecloud-web</span><br><span class="line"><span class="meta">#</span> 初始化数据库</span><br><span class="line">mysql -uadmin -p -D'cache-cloud' &lt; /opt/cachecloud/script/cachecloud.sql</span><br><span class="line"><span class="meta">#</span> 启动</span><br><span class="line">sh /opt/cachecloud-web/start.sh</span><br></pre></td></tr></table></figure>
<p>如果你发现启动脚本运行的时间很长，可能是已经报错了，<code>tail</code>一下日志</p>
<p>如果报<code>Unrecognized VM option &#39;UnlockCommercialFeatures&#39;</code>的错误，在启动脚本中将<code>-XX:+UnlockCommercialFeatures -XX:+FlightRecorder</code>去掉即可</p>
<h3 id="使用CacheCloud和配置Redis："><a href="#使用CacheCloud和配置Redis：" class="headerlink" title="使用CacheCloud和配置Redis："></a>使用CacheCloud和配置Redis：</h3><p>在<code>cachecloud</code>的<code>script</code>目录下有一个初始化脚本<code>cachecloud-init.sh</code></p>
<p>这个脚本有3个作用：</p>
<ol>
<li>创建<code>cachecloud</code>项目的用户</li>
<li>创建<code>cachecloud</code>项目的相关目录</li>
<li>安装<code>redis</code></li>
</ol>
<p>将这个脚本拷贝到需要管理的机器上，然后执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cachecloud-init.sh username</span><br></pre></td></tr></table></figure>
<p>此处的<code>username</code>是你用于创建管理<code>redis</code>的用户名</p>
<p>执行后，你需要输入两次密码</p>
<p>使用管理员账号进入<code>web</code>管理页面，在<code>管理后台</code>&gt;<code>机器管理</code>中添加我们初始化后的机器</p>
<p>接着，我们可以使用任意账号在<code>应用申请</code>界面申请<code>redis</code>服务</p>
<p><code>cachecloud</code>提供3种<code>redis</code>服务</p>
<ol>
<li>单节点<code>redis</code></li>
<li><code>Redis-Sentinel</code></li>
<li>原生的<code>Redis-Cluster</code>集群</li>
</ol>
<p>申请了我们需要的<code>redis</code>服务之后，管理员就可以在<code>管理后台</code>&gt;<code>流程审批</code>界面分配<code>redis</code>服务了</p>
<h3 id="使用CacheCloud配置Codis集群"><a href="#使用CacheCloud配置Codis集群" class="headerlink" title="使用CacheCloud配置Codis集群"></a>使用CacheCloud配置Codis集群</h3><h4 id="为codis添加redis-server"><a href="#为codis添加redis-server" class="headerlink" title="为codis添加redis-server"></a>为codis添加redis-server</h4><p>值得注意的是，<code>Codis</code>集群不能直接使用<code>Redis-Server</code>，我们需要使用<code>codis</code>安装目录下的<code>codis-server</code>替换掉<code>PATH</code>路径下的<code>redis-server</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp codis-server /usr/bin/redis-server</span><br><span class="line">cp codis-server /usr/local/bin/redis-server</span><br></pre></td></tr></table></figure>
<p>这样我们使用<code>CacheCloud</code>创建的就是<code>codis-server</code>了</p>
<p>现在我们在<code>CacheCloud</code>中创建两个单节点<code>redis</code>，然后在<code>管理后台</code>&gt;<code>流程审批</code>&gt;<code>应用运维</code>中为两个<code>redis</code>分别配置<code>slave</code></p>
<p>现在我们得到了两对<code>redis</code>主从，然后我们进入<code>Codis</code>的管理界面，在<code>Group</code>中将这两对主从添加为两组<code>Group</code>，再在<code>Slots</code>中点击<code>Reblance All Slots</code></p>
<p>至此<code>Codis</code>集群就搭建完成了</p>
<p>现在我们为<code>Codis</code>集群添加<code>Sentinel</code></p>
<h4 id="为什么要手动启动sentinel"><a href="#为什么要手动启动sentinel" class="headerlink" title="为什么要手动启动sentinel"></a>为什么要手动启动sentinel</h4><p>需要说明的一点是，我们可以在<code>CacheCloud</code>中可以直接配置<code>Redis-Sentinel</code>集群，似乎我们直接在<code>CacheCloud</code>中配置好<code>Redis-Sentinel</code>集群，然后将配置好的<code>redis</code>和<code>sentinel</code>添加到<code>codis</code>中，这样更简单。但是这样做是不可行的。</p>
<p>正常情况下，添加了<code>sentinel</code>的<code>codis</code>集群在<code>redis-server主节点</code>宕机后，<code>codis-proxy</code>会自动<code>failover</code>到<code>redis-server从节点</code>。</p>
<p>但是，但是如果<code>codis</code>添加的是通过<code>cachecloud</code>生成的<code>sentinel</code>，则由于<code>cachecloud</code>和<code>codis</code>都对<code>sentinel</code>进行了配置，导致<code>sentinel</code>对同一套主从侦测了两次，在<code>redis-server主节点</code>宕机后，<code>sentinel</code>的<code>cachecloud</code>配置生效，而<code>codis</code>配置不生效，所以<code>codis-proxy</code>无法正常<code>failover</code>。</p>
<p>所以在<code>cachecloud</code>和<code>codis</code>联合使用时，不要在<code>codis</code>中配置<code>cachecloud</code>生成的<code>sentinel</code>。</p>
<p>而为<code>codis</code>单独配置<code>sentinel</code>也很简单。</p>
<h4 id="添加sentinel"><a href="#添加sentinel" class="headerlink" title="添加sentinel"></a>添加sentinel</h4><p>首先创建一个简单的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> vim sentinel.conf </span><br><span class="line">port 26379</span><br><span class="line">dir /tmp</span><br><span class="line">protected-mode no # 较早的redis版本不需要该参数</span><br></pre></td></tr></table></figure>
<p>然后启动<code>sentinel</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server sentinel.conf --sentinel &amp;</span><br></pre></td></tr></table></figure>
<p>然后我们添加<code>sentinel</code>的地址添加到<code>codis</code>配置页面的<code>sentinels</code>配置项中即可。</p>
</div><div class="tags"><a href="/tags/redis/">redis</a><a href="/tags/codis/">codis</a><a href="/tags/cachecloud/">cachecloud</a><a href="/tags/集群/">集群</a><a href="/tags/安装部署/">安装部署</a></div><div class="post-nav"><a class="pre" href="/2017/12/28/使用Navicat链接proxysql无法进行用户管理/">使用Navicat链接proxysql无法进行用户管理</a><a class="next" href="/2017/12/25/OpenTSDB-的安装与部署/">OpenTSDB 的安装与部署</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://qwerkael.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/opentsdb/" style="font-size: 15px;">opentsdb</a> <a href="/tags/时序数据库/" style="font-size: 15px;">时序数据库</a> <a href="/tags/proxysql/" style="font-size: 15px;">proxysql</a> <a href="/tags/maxwell/" style="font-size: 15px;">maxwell</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/clickhouse/" style="font-size: 15px;">clickhouse</a> <a href="/tags/mycat/" style="font-size: 15px;">mycat</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/tilda/" style="font-size: 15px;">tilda</a> <a href="/tags/terminal/" style="font-size: 15px;">terminal</a> <a href="/tags/Linux日常/" style="font-size: 15px;">Linux日常</a> <a href="/tags/Q-A/" style="font-size: 15px;">Q&A</a> <a href="/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/tags/pacman/" style="font-size: 15px;">pacman</a> <a href="/tags/yaourt/" style="font-size: 15px;">yaourt</a> <a href="/tags/cli/" style="font-size: 15px;">cli</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/安装/" style="font-size: 15px;">安装</a> <a href="/tags/buffer-pool/" style="font-size: 15px;">buffer pool</a> <a href="/tags/审计/" style="font-size: 15px;">审计</a> <a href="/tags/权限控制/" style="font-size: 15px;">权限控制</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/codis/" style="font-size: 15px;">codis</a> <a href="/tags/cachecloud/" style="font-size: 15px;">cachecloud</a> <a href="/tags/集群/" style="font-size: 15px;">集群</a> <a href="/tags/安装部署/" style="font-size: 15px;">安装部署</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/字符集/" style="font-size: 15px;">字符集</a> <a href="/tags/乱码/" style="font-size: 15px;">乱码</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/yum/" style="font-size: 15px;">yum</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/TIME-WAIT/" style="font-size: 15px;">TIME_WAIT</a> <a href="/tags/proxySQL/" style="font-size: 15px;">proxySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/22/为InnoDB存储引擎配置内存分配器/">为InnoDB存储引擎配置内存分配器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/26/maxwell-kafka-clickhouse/">maxwell + kafka + clickhouse</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/23/python中的迭代/">python中的迭代</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题/">解决ProxySQL连接MySQL产生大量TIME_WAIT连接的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/08/yaourt-pacman加速3连/">yaourt/pacman加速3连</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/03/安装合集/">安装合集</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/使用Navicat链接proxysql无法进行用户管理/">使用Navicat链接proxysql无法进行用户管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/使用cachecloud和codis搭建redis环境/">使用cachecloud和codis搭建redis环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/OpenTSDB-的安装与部署/">OpenTSDB 的安装与部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/tilda-无法设置透明模式/">tilda 无法设置透明模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://www.percona.com" title="Percona官网" target="_blank">Percona官网</a><ul></ul><a href="http://mysql.taobao.org/monthly/" title="淘宝内核月报" target="_blank">淘宝内核月报</a><ul></ul><a href="https://yandex.com/blog/clickhouse" title="ClickHouse Blog" target="_blank">ClickHouse Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">QWERKael's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>